Running all tests...
PASS test/assertions/contains.test.ts
  handleContains
    âœ“ should pass when output contains the expected string (12 ms)
    âœ“ should fail when output does not contain the expected string (1 ms)
    âœ“ should handle number values (2 ms)
    âœ“ should handle inverse assertion correctly (2 ms)
    âœ“ should use valueFromScript over renderedValue when available (5 ms)
    âœ“ should throw error when value is missing (88 ms)
  handleIContains
    âœ“ should pass when output contains the expected string case-insensitively (2 ms)
    âœ“ should handle mixed case in output and value (2 ms)
  handleContainsAny
    âœ“ should pass when output contains any of the expected strings (2 ms)
    âœ“ should handle comma-separated string input (1 ms)
    âœ“ should handle quoted values with commas
    âœ“ should handle complex quoted values with commas and spaces (5 ms)
    âœ“ should handle empty quoted strings
    âœ“ should handle escaped quotes and commas in quoted strings (1 ms)
    âœ“ should handle null value after regex match (1 ms)
    âœ“ should handle regex match with no groups (1 ms)
    âœ“ should handle regex match with escaped characters (5 ms)
    âœ“ should handle regex match with complex escaping
    âœ“ should handle regex match with unmatched quotes (1 ms)
  handleIContainsAny
    âœ“ should pass when output contains any of the expected strings case-insensitively (1 ms)
    âœ“ should handle comma-separated string input case-insensitively (1 ms)
    âœ“ should handle string input with multiple commas and spaces
    âœ“ should handle empty string in comma-separated list (3 ms)
    âœ“ should handle string value with spaces (1 ms)
    âœ“ should handle string value with multiple spaces between commas
    âœ“ should handle string value with multiple spaces and special characters
    âœ“ should handle string value with multiple spaces and commas (5 ms)
    âœ“ should handle string value with multiple consecutive commas (1 ms)
    âœ“ should handle string value with only spaces and commas (1 ms)
  handleContainsAll
    âœ“ should pass when output contains all expected strings (6 ms)
    âœ“ should fail when output is missing some expected strings (1 ms)
  handleIContainsAll
    âœ“ should pass when output contains all expected strings case-insensitively (1 ms)
    âœ“ should fail when output is missing some expected strings case-insensitively (5 ms)
    âœ“ should handle mixed case in both output and expected values (1 ms)

PASS test/util/transform.test.ts
  util
    transform
      âœ“ transforms output using a direct function (44 ms)
      âœ“ transforms vars using a direct function (8 ms)
      âœ“ transforms output using an imported function from a file (3 ms)
      âœ“ transforms vars using a direct function from a file (5 ms)
      âœ“ throws error if transform function does not return a value (51 ms)
      âœ“ throws error if file does not export a function (4 ms)
      âœ“ transforms output using a Python file (3 ms)
      âœ“ throws error for unsupported file format (15 ms)
      âœ“ transforms output using a multi-line function (2 ms)
      âœ“ transforms output using a default export function from a file (2 ms)
      âœ“ transforms output using a named function from a JavaScript file (6 ms)
      âœ“ transforms output using a named function from a Python file (2 ms)
      âœ“ falls back to get_transform for Python files when no function name is provided (9 ms)
      âœ“ does not throw error when validateReturn is false and function returns undefined (2 ms)
      âœ“ throws error when validateReturn is true and function returns undefined (2 ms)
      âœ“ handles file transform function errors gracefully (15 ms)
      âœ“ handles inline transform function errors gracefully (9 ms)
      file path handling
        âœ“ handles absolute paths in transform files (3 ms)
        âœ“ handles file URLs in transform files (1 ms)
        âœ“ handles Python files with absolute paths (1 ms)
        âœ“ handles complex nested paths (18 ms)
        âœ“ handles paths with special characters (1 ms)

PASS test/util/json.test.ts
  json utilities
    isValidJson
      âœ“ returns true for valid JSON (38 ms)
      âœ“ returns false for invalid JSON (2 ms)
    safeJsonStringify
      âœ“ stringifies simple objects (11 ms)
      âœ“ handles circular references (1 ms)
      âœ“ pretty prints when specified (16 ms)
      âœ“ handles null values (1 ms)
      âœ“ handles undefined values (8 ms)
      âœ“ returns undefined or strips non-serializable values (2 ms)
      âœ“ returns undefined for circular references in arrays (11 ms)
      âœ“ handles complex nested structures (16 ms)
      âœ“ handles arrays with circular references
      âœ“ handles nested circular references
      âœ“ preserves non-circular nested structures (5 ms)
    extractJsonObjects
      âœ“ should extract a single JSON object from a string (33 ms)
      âœ“ should extract multiple JSON objects from a string (37 ms)
      âœ“ should return an empty array if no JSON objects are found (1 ms)
      âœ“ should handle nested JSON objects (30 ms)
      âœ“ should handle comments (42 ms)
      âœ“ should handle jsonl (24 ms)
      âœ“ should handle invalid JSON gracefully (30 ms)
      âœ“ should handle incomplete JSON (26 ms)
      âœ“ should handle string containing incomplete JSON (58 ms)
      âœ“ should handle this case (391 ms)
      âœ“ should handle YAML-style unquoted strings (21 ms)
      âœ“ should skip non-object YAML values (16 ms)
      âœ“ should handle YAML with mixed quoted and unquoted strings (46 ms)
      âœ“ should ignore YAML arrays and scalars (9 ms)
      âœ“ should handle YAML with special characters (43 ms)
      convertSlashCommentsToHash
        âœ“ should convert basic // comments to # comments
        âœ“ should not convert // inside double quoted strings (7 ms)
        âœ“ should not convert // inside single quoted strings (4 ms)
        âœ“ should handle escaped quotes in strings (1 ms)
        âœ“ should handle multiple comments in one line (1 ms)
        âœ“ should handle comments at the start of the line
        âœ“ should handle strings with multiple lines (5 ms)
        âœ“ should handle nested quotes
        âœ“ should handle mixed single and double quotes (1 ms)
        âœ“ should handle empty strings
        âœ“ should handle strings without comments (8 ms)
        âœ“ should handle strings with only a comment
        âœ“ should handle multiple sequential comment markers (1 ms)
        âœ“ should handle JSON-like structures
        âœ“ should handle comments after different types of values (13 ms)
      LLM output scenarios
        âœ“ should handle JSON with inline comments (38 ms)
        âœ“ should handle JSON with multiline string containing markdown (122 ms)
        âœ“ should handle JSON with unescaped backticks (46 ms)
        âœ“ should handle JSON with trailing commas (36 ms)
        âœ“ should handle multiple JSON objects in LLM output with text in between (67 ms)
    orderKeys
      âœ“ orders keys according to specified order (1 ms)
      âœ“ places unspecified keys at the end (10 ms)
      âœ“ ignores specified keys that do not exist in the object
      âœ“ returns an empty object when input is empty (1 ms)
      âœ“ returns the original object when order is empty
      âœ“ preserves nested object structures (1 ms)
      âœ“ handles objects with symbol keys (1 ms)
      âœ“ maintains the correct types for keys and values (1 ms)
    extractFirstJsonObject
      âœ“ should extract the first JSON object from a string (12 ms)
      âœ“ should throw an error when no JSON objects are found (103 ms)

PASS test/csv.test.ts
  testCaseFromCsvRow
    âœ“ should create a TestCase with assertions and options from a CSV row (22 ms)
    âœ“ should handle CSV row with only variables (2 ms)
    âœ“ should log a warning for single underscore usage with reserved keys (2 ms)
  assertionFromString
    âœ“ should create an equality assertion (1 ms)
    âœ“ should create an is-json assertion (1 ms)
    âœ“ should create an is-json assertion with value (1 ms)
    âœ“ should create an contains-json assertion (1 ms)
    âœ“ should create a function assertion (1 ms)
    âœ“ should create a similarity assertion (6 ms)
    âœ“ should create a contains assertion (1 ms)
    âœ“ should create a not-contains assertion (1 ms)
    âœ“ should create a contains-any assertion (1 ms)
    âœ“ should create a contains-all assertion (1 ms)
    âœ“ should create a regex assertion (5 ms)
    âœ“ should create a not-regex assertion (1 ms)
    âœ“ should create an icontains assertion (1 ms)
    âœ“ should create a not-icontains assertion (1 ms)
    âœ“ should create a webhook assertion (9 ms)
    âœ“ should create a not-webhook assertion (6 ms)
    âœ“ should create a rouge-n assertion (2 ms)
    âœ“ should create a not-rouge-n assertion (8 ms)
    âœ“ should create a starts-with assertion (1 ms)
    âœ“ should create a levenshtein assertion (1 ms)
    âœ“ should create a classifier assertion (8 ms)
    âœ“ should create a latency assertion
    âœ“ should create a perplexity assertion
    âœ“ should create a perplexity-score assertion (8 ms)
    âœ“ should create a cost assertion
    âœ“ should create an openai function call assertion
    âœ“ should create a python assertion (1 ms)
    âœ“ should parse python: assertion (7 ms)
    âœ“ should parse file:// prefix assertion (1 ms)
    âœ“ should parse file:// prefix assertion with function name (1 ms)
    âœ“ should create a javascript assertion (1 ms)
    âœ“ should create an llm-rubric assertion with "grade:" prefix (9 ms)
    âœ“ should create an llm-rubric assertion with "llm-rubric:" prefix (1 ms)
    âœ“ should handle legacy javascript option (1 ms)
    âœ“ should handle legacy eval option
    âœ“ should handle legacy fn option
    âœ“ should use DEFAULT_SEMANTIC_SIMILARITY_THRESHOLD for similar assertion without threshold (11 ms)
    âœ“ should use 0.75 as default threshold for other assertions requiring threshold (13 ms)
    âœ“ should use provided threshold when specified (28 ms)

PASS test/fetch.test.ts
  fetchWithProxy
    âœ“ should add version header to all requests (41 ms)
    âœ“ should handle URLs with basic auth credentials (8 ms)
    âœ“ should handle URLs without auth credentials (2 ms)
    âœ“ should handle invalid URLs gracefully (2 ms)
    âœ“ should preserve existing Authorization headers when no URL credentials (1 ms)
    âœ“ should warn and prefer existing Authorization header over URL credentials (3 ms)
    âœ“ should handle empty username or password in URL (1 ms)
    âœ“ should handle URLs with only username (1 ms)
    âœ“ should preserve existing headers when adding Authorization from URL credentials (2 ms)
    âœ“ should use custom CA certificate when PROMPTFOO_CA_CERT_PATH is set (6 ms)
    âœ“ should handle missing CA certificate file gracefully (6 ms)
    âœ“ should disable SSL verification when PROMPTFOO_INSECURE_SSL is true (1 ms)
    âœ“ should resolve CA certificate path relative to basePath when available (4 ms)
    âœ“ should not create ProxyAgent when no proxy URL is found (2 ms)
    âœ“ should use proxy URL from environment variables in order of precedence (12 ms)
  fetchWithTimeout
    âœ“ should resolve when fetch completes before timeout (6 ms)
    âœ“ should reject when request times out (95 ms)
  isRateLimited
    âœ“ should detect standard rate limit headers (15 ms)
    âœ“ should detect 429 status code (1 ms)
    âœ“ should detect OpenAI specific rate limits (2 ms)
    âœ“ should return false when not rate limited (1 ms)
  handleRateLimit
    âœ“ should handle OpenAI reset headers (3 ms)
    âœ“ should handle standard rate limit reset headers (23 ms)
    âœ“ should handle Retry-After headers (7 ms)
    âœ“ should use default wait time when no headers present (2 ms)
  fetchWithRetries
    âœ“ should make exactly one attempt when retries is 0 (7 ms)
    âœ“ should handle negative retry values by treating them as 0 (1 ms)
    âœ“ should make retries+1 total attempts (8 ms)
    âœ“ should not sleep after the final attempt (7 ms)
    âœ“ should handle 5XX errors when PROMPTFOO_RETRY_5XX is true (2 ms)
    âœ“ should handle rate limits with proper backoff (5 ms)
    âœ“ should respect maximum retry count (27 ms)
    âœ“ should handle detailed error information (6 ms)
    âœ“ should handle non-Error objects in rejection (1 ms)
    âœ“ should handle rate limits with OpenAI specific headers (5 ms)
  sanitizeUrl
    âœ“ should mask credentials in URLs (1 ms)
    âœ“ should handle URLs without credentials
    âœ“ should return original string for invalid URLs

PASS test/redteam/validators.test.ts
  redteamGenerateOptionsSchema
    âœ“ should accept valid options for a redteam test (52 ms)
    âœ“ should reject invalid plugin names (7 ms)
    âœ“ should require numTests to be a positive integer (2 ms)
  redteamPluginSchema
    âœ“ should accept a valid plugin name as a string (6 ms)
    âœ“ should accept a valid plugin object (2 ms)
    âœ“ should reject an invalid plugin name (2 ms)
    âœ“ should reject a plugin object with negative numTests (2 ms)
    âœ“ should allow omitting numTests in a plugin object (2 ms)
    âœ“ should provide helpful error message for invalid plugin names (7 ms)
    âœ“ should provide helpful error message for invalid file:// paths (2 ms)
    âœ“ should provide helpful error message for invalid plugin object (8 ms)
  redteamConfigSchema
    âœ“ should accept a valid configuration with all fields (76 ms)
    âœ“ should use default values when fields are omitted (7 ms)
    âœ“ should allow omitting the purpose field (2 ms)
    âœ“ should transform string plugins to objects (2 ms)
    âœ“ should use global numTests for plugins without specified numTests (6 ms)
    âœ“ should reject invalid plugin names (1 ms)
    âœ“ should reject negative numTests (4 ms)
    âœ“ should reject non-integer numTests (1 ms)
    âœ“ should allow all valid plugin and strategy names (130 ms)
    âœ“ should expand harmful plugin to all harm categories (7 ms)
    âœ“ should allow overriding specific harm categories (9 ms)
    âœ“ should not duplicate harm categories when specified individually (41 ms)
    âœ“ should handle harmful categories without specifying harmful plugin (2 ms)
    âœ“ should reject invalid harm categories (1 ms)
    âœ“ should accept an array of injectVar strings (1 ms)
    âœ“ should accept a provider string (8 ms)
    âœ“ should accept a language string (2 ms)
    âœ“ should include injectVar, provider, and purpose when all are provided (10 ms)
    âœ“ should accept a provider object with id and config (5 ms)
    âœ“ should accept a provider object with callApi function (20 ms)
    âœ“ should reject an invalid provider (1 ms)
    âœ“ should handle plugins with config attributes (53 ms)
    âœ“ should handle PII plugins with default numTests (6 ms)
    âœ“ should sort plugins with different configurations correctly (4 ms)
    aliases
      âœ“ should expand high-level aliased plugin names (34 ms)
      âœ“ should expand granular aliased plugin names (18 ms)
      âœ“ should expand collections within aliased plugin names (1 ms)
      âœ“ should not duplicate plugins when using multiple aliased names (5 ms)
      âœ“ should expand strategies for "owasp:llm" alias (4 ms)
      âœ“ should expand strategies for "owasp:llm:01" alias (2 ms)
      âœ“ should not duplicate strategies when using multiple aliased names (1 ms)
  RedteamConfigSchema transform
    âœ“ should deduplicate plugins with same id and config (7 ms)
    âœ“ should keep plugins with same id but different configs (5 ms)
    âœ“ should sort plugins by id and then by config (2 ms)
    âœ“ should filter out collection plugins from final output (5 ms)
    âœ“ should expand collection plugins correctly (2 ms)
    âœ“ should handle plugin aliases and their associated strategies (1 ms)
    âœ“ should preserve numTests hierarchy (plugin > global) (2 ms)
    âœ“ should handle file:// paths in transform (2 ms)
    âœ“ should include all optional fields in transformed output (2 ms)
    âœ“ should omit undefined optional fields from transformed output (4 ms)
    âœ“ should handle entities array in configuration (2 ms)
    âœ“ should handle empty entities array (1 ms)
    âœ“ should preserve order of optional fields in transformed output (1 ms)
    file:// plugins
      âœ“ should accept file:// plugins in string format (1 ms)
      âœ“ should accept file:// plugins in object format (2 ms)
      âœ“ should handle mix of file:// and built-in plugins (6 ms)
      âœ“ should reject non-file:// custom paths (128 ms)
  RedteamStrategySchema
    âœ“ should accept valid built-in strategy names (1 ms)
    âœ“ should accept valid file:// paths (1 ms)
    âœ“ should provide helpful error message for invalid strategy names (6 ms)
    âœ“ should provide helpful error message for invalid file:// paths (6 ms)
    âœ“ should provide helpful error message for non-file:// paths (25 ms)
    âœ“ should provide helpful error message for invalid strategy object (6 ms)

PASS test/assertions/refusal.test.ts
  is-refusal assertion
    Basic tests
      âœ“ should pass when the output is a refusal message (1 ms)
      âœ“ should fail when the output is not a refusal message (8 ms)
      âœ“ should pass when inverse=true and output is not a refusal (1 ms)
      âœ“ should fail when inverse=true and output is a refusal (1 ms)
    Edge cases and special values
      âœ“ should handle undefined output (1 ms)
      âœ“ should handle null output (1 ms)
      âœ“ should handle empty string output (1 ms)
      âœ“ should handle whitespace-only output
      âœ“ should handle empty string with inverse=true
    Refusal pattern tests
      âœ“ should detect refusal with "I am not able to" prefix
      âœ“ should detect refusal with "As an AI" pattern (4 ms)
      âœ“ should detect refusal with ethics/legality mentions (1 ms)
      âœ“ should detect refusal with content filter message
    Case sensitivity tests
      âœ“ should detect refusal with mixed case
      âœ“ should detect refusal with all uppercase (4 ms)

PASS test/python/pythonUtils.test.ts
  pythonUtils
    tryPath
      âœ“ should return the path for a valid Python 3 executable (8 ms)
      âœ“ should return null for a non-existent executable (1 ms)
      âœ“ should return null if the command times out (16 ms)
    validatePythonPath
      âœ“ should validate an existing Python 3 path (1 ms)
      âœ“ should return the cached path on subsequent calls
      âœ“ should fall back to alternative paths for non-existent programs when not explicit (20 ms)
      âœ“ should throw an error for non-existent programs when explicit (38 ms)
      âœ“ should throw an error when no valid Python path is found (2 ms)
      âœ“ should use PROMPTFOO_PYTHON environment variable when provided (4 ms)
    runPython
      âœ“ should correctly run a Python script with provided arguments and read the output file (4 ms)
      âœ“ should log stdout and stderr (2 ms)
      âœ“ should throw an error if the Python script execution fails (10 ms)
      âœ“ should handle Python script returning incorrect result type (7 ms)
      âœ“ should handle invalid JSON in the output file (2 ms)
      âœ“ should log and throw an error with stack trace when Python script execution fails (15 ms)
      âœ“ should handle error without stack trace (11 ms)
      âœ“ should log an error when unable to remove temporary files (1 ms)

PASS test/assertions/sql.test.ts
  is-sql assertion
    Basic tests
      âœ“ should pass when the output string is a valid SQL statement (636 ms)
      âœ“ should fail when the SQL statement contains a syntax error in the ORDER BY clause (4 ms)
      âœ“ should fail when the SQL statement uses a reserved keyword as a table name (2 ms)
      âœ“ should fail when the SQL statement has an incorrect DELETE syntax (8 ms)
    Database Specific Syntax Tests
      âœ“ should fail if the output SQL statement conforms to MySQL but not PostgreSQL (27 ms)
      âœ“ should fail if the output SQL statement conforms to PostgreSQL but not MySQL (4 ms)
      âœ“ should pass if the output SQL statement conforms to PostgreSQL but not MySQL (7 ms)
    White Table/Column List Tests
      âœ“ should fail if the output SQL statement violate allowedTables (4 ms)
      âœ“ should pass if the output SQL statement does not violate allowedTables (3 ms)
      âœ“ should fail if the output SQL statement violate allowedColumns (6 ms)
      âœ“ should pass if the output SQL statement does not violate allowedColumns (9 ms)

PASS test/providers/google.test.ts
  GoogleChatProvider
    constructor and configuration
      âœ“ should handle API key from different sources (10 ms)
      âœ“ should handle API host from different sources (23 ms)
      âœ“ should handle custom provider ID
      âœ“ should handle default configuration (2 ms)
      âœ“ should handle configuration with safety settings (1 ms)
    error handling
      âœ“ should throw error when API key is not set (69 ms)
      âœ“ should handle empty candidate responses (3 ms)
      âœ“ should handle malformed API responses (2 ms)
    non-Gemini models
      âœ“ should handle errors for non-Gemini models (2 ms)
      âœ“ should call the correct API endpoint for non-Gemini models (4 ms)
    callGemini
      âœ“ should call the Gemini API and return the response with token usage (3 ms)
      âœ“ should handle cached responses correctly (1 ms)
      âœ“ should use v1alpha API for thinking model (1 ms)
      âœ“ should handle system messages correctly (1 ms)
      âœ“ should handle API call errors (2 ms)
      âœ“ should handle response schema (2 ms)
      âœ“ should handle safety ratings (1 ms)
      âœ“ should handle structured output with response schema (2 ms)
      âœ“ should handle multipart messages (1 ms)
      âœ“ should handle additional configuration options (1 ms)
      âœ“ should handle API version selection (2 ms)

PASS test/cache.test.ts
  cache configuration
    âœ“ should use memory cache in test environment (190 ms)
    âœ“ should use disk cache in non-test environment (110 ms)
    âœ“ should respect custom cache path (143 ms)
    âœ“ should respect cache configuration from environment (83 ms)
    âœ“ should handle cache directory creation when it exists (84 ms)
  fetchWithCache
    with cache enabled
      âœ“ should fetch and cache successful requests (28 ms)
      âœ“ should not cache failed requests (10 ms)
      âœ“ should handle empty responses (10 ms)
      âœ“ should handle non-JSON responses when JSON is expected (245 ms)
      âœ“ should handle request timeout (31 ms)
      âœ“ should handle network errors (12 ms)
      âœ“ should handle request options in cache key (13 ms)
      âœ“ should respect cache busting (1 ms)
    with cache disabled
      âœ“ should always fetch fresh data (7 ms)
    cache utility functions
      âœ“ should track cache enabled state (4 ms)
      âœ“ should clear cache (2 ms)

PASS test/prompts/index.test.ts
  readPrompts
    âœ“ should throw an error for invalid inputs (75 ms)
    âœ“ should throw an error for empty inputs (4 ms)
    âœ“ should throw an error when PROMPTFOO_STRICT_FILES is true and the file does not exist (13 ms)
    âœ“ should throw an error for a .txt file with no prompts (4 ms)
    âœ“ should throw an error for an unsupported file format (2 ms)
    âœ“ should read a single prompt (5 ms)
    âœ“ should read a list of prompts (4 ms)
    âœ“ should read a .txt file with a single prompt (1 ms)
    âœ“ should read a single prompt file with input:["prompts.txt"] (4 ms)
    âœ“ should read a single prompt file with input:"prompts.txt" (1 ms)
    âœ“ should read multiple prompt files (2 ms)
    âœ“ should read with map input (2 ms)
    âœ“ should read a .json file (3 ms)
    âœ“ should read a .jsonl file (1 ms)
    âœ“ should read a .yaml file (11 ms)
    âœ“ should read a .yml file (4 ms)
    âœ“ should read a .py prompt object array (4 ms)
    âœ“ should read a .py file (2 ms)
    âœ“ should read a .js file without named function (3 ms)
    âœ“ should read a .js file with named function (3 ms)
    âœ“ should read a directory (2 ms)
    âœ“ should fall back to a string if maybeFilePath is true but a file does not exist (1 ms)
    âœ“ should handle a prompt with a function (2 ms)
  readProviderPromptMap
    âœ“ should return an empty object if config.providers is undefined
    âœ“ should return a map with all prompts if config.providers is a string (1 ms)
    âœ“ should return a map with all prompts if config.providers is a function (1 ms)
    âœ“ should handle provider objects with id and prompts (1 ms)
    âœ“ should handle provider objects with id, label, and prompts (1 ms)
    âœ“ should handle provider options map with id and prompts (1 ms)
    âœ“ should handle provider options map without id and use original id (1 ms)
    âœ“ should use rawProvider.prompts if provided for provider objects with id (25 ms)
    âœ“ should fall back to allPrompts if no prompts provided for provider objects with id (1 ms)
    âœ“ should use rawProvider.prompts for both id and label if provided
    âœ“ should fall back to allPrompts for both id and label if no prompts provided (1 ms)
    âœ“ should use providerObject.id from ProviderOptionsMap when provided (9 ms)
    âœ“ should fallback to originalId when providerObject.id is not specified in ProviderOptionsMap (1 ms)

PASS test/providers/groq.test.ts
  Groq
    GroqProvider
      âœ“ should initialize with correct model name (85 ms)
      âœ“ should return correct id (2 ms)
      âœ“ should return correct string representation (25 ms)
      âœ“ should identify reasoning models correctly (2 ms)
      âœ“ should handle temperature support correctly (23 ms)
      âœ“ should serialize to JSON correctly without API key (2 ms)
      âœ“ should serialize to JSON correctly with API key redacted (17 ms)
      âœ“ should handle configuration options correctly (1 ms)
      callApi
        âœ“ should call Groq API and return output with correct structure (117 ms)
        âœ“ should use cache by default (7 ms)
        âœ“ should handle API errors (6 ms)
        âœ“ should handle network errors (2 ms)
        âœ“ should handle empty response (2 ms)
        âœ“ should handle tool calls and function callbacks (3 ms)
        âœ“ should handle invalid tool calls (28 ms)
        âœ“ should handle system prompts correctly (8 ms)
        âœ“ should handle API key from environment variable (2 ms)
        âœ“ should handle malformed API response (7 ms)
        âœ“ should handle rate limit errors (2 ms)

PASS test/providers/watsonx.test.ts
  WatsonXProvider
    constructor
      âœ“ should initialize with modelName and config (59 ms)
      âœ“ should initialize with default id based on modelName (16 ms)
    id
      âœ“ should return the correct id string (2 ms)
    toString
      âœ“ should return the correct string representation (2 ms)
    getClient
      âœ“ should initialize WatsonXAI client with correct parameters (18 ms)
      âœ“ should throw an error if neither API key nor Bearer Token is set (158 ms)
    constructor with Bearer Token
      âœ“ should use Bearer Token Authentication when apiKey is not provided (16 ms)
      âœ“ should prefer API Key Authentication over Bearer Token Authentication when both are provided (7 ms)
      âœ“ should use IAM Authentication when WATSONX_AI_AUTH_TYPE is set to iam (7 ms)
      âœ“ should use Bearer Token Authentication when WATSONX_AI_AUTH_TYPE is set to bearertoken (2 ms)
      âœ“ should fallback to default behavior when WATSONX_AI_AUTH_TYPE is invalid (5 ms)
    callApi
      âœ“ should call generateText with correct parameters and return the correct response (14 ms)
      âœ“ should return cached response if available (20 ms)
      âœ“ should handle API errors gracefully (9 ms)
    calculateWatsonXCost
      âœ“ should calculate cost correctly when token counts are provided (13 ms)
      âœ“ should calculate cost correctly for class_9 tier (2 ms)

PASS test/providers/mistral.test.ts
  Mistral
    MistralChatCompletionProvider
      âœ“ should create a provider with default options (15 ms)
      âœ“ should create a provider with custom options (2 ms)
      âœ“ should call Mistral API and return output with correct structure (8 ms)
      âœ“ should use cache when enabled (3 ms)
      âœ“ should not use cache when disabled (3 ms)
      âœ“ should handle API errors (2 ms)
      âœ“ should use custom API base URL if provided (3 ms)
      âœ“ should use API host if provided (2 ms)
    MistralEmbeddingProvider
      âœ“ should create a provider with default options (2 ms)
      âœ“ should call Mistral Embedding API and return embedding with correct structure (4 ms)
      âœ“ should use cache for embedding when enabled (2 ms)
      âœ“ should not use cache for embedding when disabled (22 ms)
      âœ“ should handle API errors (33 ms)
      âœ“ should return provider id and string representation (1 ms)
      âœ“ should use custom API base URL if provided (2 ms)

PASS test/util/testCaseReader.test.ts
  readStandaloneTestsFile
    âœ“ should read CSV file and return test cases (70 ms)
    âœ“ should read CSV file with BOM (Byte Order Mark) and return test cases (7 ms)
    âœ“ should read JSON file and return test cases (10 ms)
    âœ“ should read YAML file and return test cases (42 ms)
    âœ“ should read Google Sheets and return test cases (6 ms)
    âœ“ should read JS file and return test cases (4 ms)
    âœ“ should handle file:// prefix in file path (2 ms)
    âœ“ should return an empty array for unsupported file types (1 ms)
    âœ“ should read CSV file with default delimiter (8 ms)
    âœ“ should read CSV file with custom delimiter (4 ms)
    âœ“ should handle Python files with default function name (2 ms)
    âœ“ should handle Python files with custom function name (1 ms)
    âœ“ should throw error when Python file returns non-array (123 ms)
    âœ“ should throw error for invalid Python file path (4 ms)
  readTest
    âœ“ readTest with string input (path to test config) (7 ms)
    âœ“ readTest with TestCase input
    âœ“ readTest with invalid input (2 ms)
    âœ“ readTest with TestCase that contains a vars glob input (3 ms)
    readTest with provider
      âœ“ should load provider when provider is a string (6 ms)
      âœ“ should load provider when provider is an object with id (2 ms)
  readTests
    âœ“ readTests with string input (CSV file path) (2 ms)
    âœ“ readTests with string input (CSV file path with file:// prefix) (3 ms)
    âœ“ readTests with multiple __expected in CSV (7 ms)
    âœ“ readTests with array input (TestCase[]) (1 ms)
    âœ“ readTests with string array input (paths to test configs) (19 ms)
    âœ“ readTests with vars glob input (paths to vars configs) (12 ms)
    âœ“ readTests with single TestCase content (10 ms)
    âœ“ should read tests from a Google Sheets URL (12 ms)
    âœ“ should log a warning for unsupported test format (2 ms)
    âœ“ should not log a warning if tests is undefined (1 ms)
    âœ“ should read tests from multiple Google Sheets URLs (10 ms)
    âœ“ should handle HuggingFace dataset URLs (2 ms)
    âœ“ should handle JSONL files (2 ms)
    âœ“ should handle file read errors gracefully (4 ms)
    âœ“ should handle Python files in readTests (1 ms)
    âœ“ should handle Python files with custom function in readTests (8 ms)
    âœ“ should handle Python files with invalid function name in readTests (2 ms)
    âœ“ should handle Python files that return non-array in readTests (2 ms)
    âœ“ should warn when assert is found in vars (3 ms)
    âœ“ should not warn about assert in vars when environment variable is set (2 ms)
  testCaseFromCsvRow
    âœ“ should convert a CSV row to a TestCase object (1 ms)
  readVarsFiles
    âœ“ should read variables from a single YAML file (1 ms)
    âœ“ should read variables from multiple YAML files (2 ms)
  loadTestsFromGlob
    âœ“ should handle Hugging Face dataset URLs (1 ms)

PASS test/assertions/utils.test.ts
  processFileReference
    âœ“ should handle undefined basePath (3 ms)
    âœ“ should process JSON files correctly (12 ms)
    âœ“ should process YAML files correctly (1 ms)
    âœ“ should process YML files correctly (1 ms)
    âœ“ should process TXT files correctly (3 ms)
    âœ“ should throw an error for unsupported file types (41 ms)
  coerceString
    âœ“ should return string as is when input is a string (23 ms)
    âœ“ should convert object to JSON string (1 ms)
    âœ“ should convert array to JSON string
    âœ“ should handle empty object (1 ms)
  getFinalTest
    âœ“ should correctly merge test and assertion data (2 ms)
    âœ“ should use test provider when assertion provider is not provided (1 ms)
    âœ“ should handle test with direct provider property (1 ms)
    âœ“ should handle undefined providers correctly (1 ms)
    âœ“ should handle both provider in options and direct provider (1 ms)
  loadFromJavaScriptFile
    âœ“ should call named function when functionName is provided (2 ms)
    âœ“ should call default function when no functionName provided (1 ms)
    âœ“ should call default export function when available (5 ms)
    âœ“ should throw error when module does not export a function (2 ms)
    âœ“ should throw error when named function does not exist (1 ms)

PASS test/redteam/plugins/base.test.ts
  RedteamPluginBase
    âœ“ should generate test cases correctly (163 ms)
    âœ“ should filter and process prompts correctly (12 ms)
    âœ“ should handle batching when requesting more than 20 tests (22 ms)
    âœ“ should deduplicate prompts (28 ms)
    âœ“ should retry when not enough unique prompts are generated (6 ms)
    âœ“ should bail after 2 retries if no new prompts are generated (20 ms)
    âœ“ should sample prompts when more are generated than requested (9 ms)
    appendModifiers
      âœ“ should not append modifiers when all modifier values are undefined or empty strings (11 ms)
      âœ“ should append modifiers when at least one modifier has a non-empty value (13 ms)
      âœ“ should append language modifier (3 ms)
    parseGeneratedPrompts
      âœ“ should parse simple prompts correctly (1 ms)
      âœ“ should handle prompts with quotation marks (1 ms)
      âœ“ should ignore lines without "Prompt:" (1 ms)
      âœ“ should handle prompts with numbers (12 ms)
      âœ“ should handle prompts with colons (1 ms)
      âœ“ should handle empty input (1 ms)
      âœ“ should handle input with only invalid lines (10 ms)
      âœ“ should trim whitespace from prompts (8 ms)
      âœ“ should handle prompts with multiple lines (1 ms)
      âœ“ should handle numbered lists with various formats (1 ms)
      âœ“ should handle prompts with nested quotes (13 ms)
      âœ“ should handle prompts with multiple spaces between words (1 ms)
      âœ“ should handle a mix of valid and invalid prompts (1 ms)
      âœ“ should strip leading and trailing asterisks but leave ones in the middle (1 ms)
  RedteamGraderBase
    âœ“ should throw an error if test is missing purpose metadata (167 ms)
    âœ“ should render the rubric with correct variables (13 ms)
    âœ“ should return the result from matchesLlmRubric (1 ms)
    grader examples
      âœ“ should append grader examples to rubric when present (10 ms)
      âœ“ should not append grader examples when not present (1 ms)
    RedteamGraderBase with tools
      âœ“ should handle tools from provider config (4 ms)
      âœ“ should handle when no tools are provided (10 ms)
    empty and refusal handling
      âœ“ should auto-pass empty responses (1 ms)
      âœ“ should auto-pass JSON empty object responses (27 ms)
      âœ“ should auto-pass refusal responses (8 ms)
      âœ“ should not auto-pass valid responses (5 ms)

PASS test/googleSheets.test.ts
  Google Sheets Integration
    checkGoogleSheetAccess
      âœ“ should return public:true for accessible sheets (2 ms)
      âœ“ should return public:false for inaccessible sheets (1 ms)
      âœ“ should handle network errors gracefully (1 ms)
    fetchCsvFromGoogleSheetUnauthenticated
      âœ“ should fetch and parse CSV data correctly (21 ms)
      âœ“ should handle gid parameter correctly (2 ms)
      âœ“ should throw error on non-200 response (37 ms)
    fetchCsvFromGoogleSheetAuthenticated
      âœ“ should fetch and parse authenticated sheet data (3 ms)
      âœ“ should handle gid parameter correctly (2 ms)
      âœ“ should throw error for invalid sheet URL (1 ms)
    writeCsvToGoogleSheet
      âœ“ should write data to existing sheet (2 ms)
      âœ“ should create new sheet when no gid provided (3 ms)
      âœ“ should use existing sheet when gid provided (2 ms)
      âœ“ should throw error for invalid sheet URL (1 ms)

PASS test/share.test.ts
  stripAuthFromUrl
    âœ“ removes username and password from URL (2 ms)
    âœ“ handles URLs without auth info (6 ms)
    âœ“ handles URLs with only username (1 ms)
    âœ“ handles URLs with special characters in auth
    âœ“ returns original string for invalid URLs (1 ms)
    âœ“ handles URLs with IP addresses
  createShareableUrl
    âœ“ creates correct URL for cloud config and updates author (8 ms)
    chunked vs regular sending
      âœ“ sends regular eval when cloud build date is older than supported (8 ms)
      âœ“ sends chunked eval when cloud build date is newer than supported (11 ms)
      âœ“ sends regular eval when open source version is older than supported (68 ms)
      âœ“ sends chunked eval when open source version is newer than supported (9 ms)

PASS test/util/index.test.ts
  maybeLoadFromExternalFile
    âœ“ should return the input if it is not a string (10 ms)
    âœ“ should return the input if it does not start with "file://" (1 ms)
    âœ“ should throw an error if the file does not exist (120 ms)
    âœ“ should return the file contents for a non-JSON, non-YAML file (2 ms)
    âœ“ should parse and return JSON content for a .json file (5 ms)
    âœ“ should parse and return YAML content for a .yaml file (10 ms)
    âœ“ should parse and return YAML content for a .yml file (3 ms)
    âœ“ should use basePath when resolving file paths (3 ms)
    âœ“ should handle relative paths correctly (3 ms)
    âœ“ should handle a path with environment variables in Nunjucks template (8 ms)
    âœ“ should ignore basePath when file path is absolute (3 ms)
    âœ“ should handle list of paths (7 ms)
  util
    âœ“ readFilters (7 ms)
    writeOutput
      âœ“ writeOutput with CSV output (13 ms)
      âœ“ writeOutput with JSON output (3 ms)
      âœ“ writeOutput with YAML output (8 ms)
      âœ“ writeOutput with json and txt output (4 ms)
      âœ“ writes output to Google Sheets (3 ms)
    readOutput
      âœ“ reads JSON output (1 ms)
      âœ“ fails for csv output (5 ms)
      âœ“ fails for yaml output (3 ms)
    providerToIdentifier
      âœ“ works with string (1 ms)
      âœ“ works with provider id undefined (4 ms)
      âœ“ works with ApiProvider (1 ms)
      âœ“ works with ProviderOptions (5 ms)
    varsMatch
      âœ“ true with both undefined (1 ms)
      âœ“ false with one undefined (1 ms)
    resultIsForTestCase
      âœ“ is true (5 ms)
      âœ“ is false if provider is different (1 ms)
      âœ“ is false if vars are different
    parsePathOrGlob
      âœ“ should parse a simple file path with extension (2 ms)
      âœ“ should parse a file path with function name (5 ms)
      âœ“ should parse a directory path (1 ms)
      âœ“ should handle non-existent file path gracefully when PROMPTFOO_STRICT_FILES is false (2 ms)
      âœ“ should throw an error for non-existent file path when PROMPTFOO_STRICT_FILES is true (32 ms)
      âœ“ should return empty extension for files without extension (1 ms)
      âœ“ should handle relative paths (2 ms)
      âœ“ should handle paths with environment variables (1 ms)
      âœ“ should handle glob patterns in file path (1 ms)
      âœ“ should handle complex file paths (1 ms)
      âœ“ should handle non-standard file extensions (14 ms)
      âœ“ should handle deeply nested file paths (1 ms)
      âœ“ should handle complex directory paths (1 ms)
      âœ“ should join basePath and safeFilename correctly (2 ms)
      âœ“ should handle empty basePath (7 ms)
      âœ“ should handle file:// prefix (1 ms)
      âœ“ should handle file://./... with absolute base path (1 ms)
      âœ“ should handle file://./... with relative base path (5 ms)
      Grader
        âœ“ should have an id and callApi attributes (1 ms)

PASS test/util/templates.test.ts
  extractVariablesFromTemplate
    âœ“ should extract simple variables (18 ms)
    âœ“ should extract variables without spaces (1 ms)
    âœ“ should extract variables with dot notation (11 ms)
    âœ“ should extract variables with underscores (1 ms)
    âœ“ should extract variables with numbers (1 ms)
    âœ“ should extract variables used in filters (1 ms)
    âœ“ should extract variables used in complex expressions
    âœ“ should extract variables from for loops (11 ms)
    âœ“ should extract variables with multiple occurrences (1 ms)
    âœ“ should not extract variables from comments (1 ms)
    âœ“ should handle empty templates (1 ms)
    âœ“ should handle templates without variables (3 ms)
  extractVariablesFromTemplates
    âœ“ should extract variables from multiple templates (1 ms)
    âœ“ should handle empty array of templates
    âœ“ should deduplicate variables across templates (1 ms)
  getNunjucksEngine
    âœ“ should return a nunjucks environment by default (41 ms)
    âœ“ should return a simple render function when PROMPTFOO_DISABLE_TEMPLATING is set (1 ms)
    âœ“ should return a nunjucks environment when isGrader is true, regardless of PROMPTFOO_DISABLE_TEMPLATING (12 ms)
    âœ“ should use nunjucks when isGrader is true, even if PROMPTFOO_DISABLE_TEMPLATING is set (38 ms)
    âœ“ should add custom filters when provided (8 ms)
    âœ“ should add environment variables as globals under "env" (3 ms)
    âœ“ should throw an error when throwOnUndefined is true and a variable is undefined (60 ms)
    âœ“ should not throw an error when throwOnUndefined is false and a variable is undefined (7 ms)
    âœ“ should respect all parameters when provided (11 ms)
    environment variables as globals
      âœ“ should add environment variables as globals by default (6 ms)
      âœ“ should not add environment variables when PROMPTFOO_DISABLE_TEMPLATE_ENV_VARS is true (6 ms)
      âœ“ should not add environment variables when in self-hosted mode by default (2 ms)
      âœ“ should add environment variables in self-hosted mode when explicitly enabled (5 ms)

PASS test/envars.test.ts
  envars
    getEnvar
      âœ“ should return the value of an existing environment variable (2 ms)
      âœ“ should return undefined for a non-existing environment variable (1 ms)
      âœ“ should return the default value for a non-existing environment variable (1 ms)
    getEnvBool
      âœ“ should return true for truthy string values (2 ms)
      âœ“ should return false for falsy string values (5 ms)
      âœ“ should return the default value for a non-existing environment variable (1 ms)
      âœ“ should return true for uppercase truthy string values (7 ms)
      âœ“ should return false for any other string values (1 ms)
      âœ“ should return true when the environment variable is set to "1" (22 ms)
      âœ“ should return false when the environment variable is set to "0" (1 ms)
      âœ“ should return false when no default value is provided and the environment variable is not set (1 ms)
    getEnvInt
      âœ“ should return the integer value of an existing environment variable (5 ms)
      âœ“ should return undefined for a non-numeric environment variable
      âœ“ should return the default value for a non-existing environment variable (5 ms)
      âœ“ should floor a floating-point number in the environment variable
      âœ“ should handle negative numbers (1 ms)
      âœ“ should return undefined for empty string (5 ms)
      âœ“ should return the default value when the environment variable is undefined (1 ms)
      âœ“ should return undefined when no default value is provided and the environment variable is not set (12 ms)
    getEnvFloat
      âœ“ should return the float value of an existing environment variable (3 ms)
      âœ“ should return undefined for a non-numeric environment variable (8 ms)
      âœ“ should return the default value for a non-existing environment variable
      âœ“ should handle integer values (1 ms)
      âœ“ should handle negative numbers (8 ms)
      âœ“ should return undefined for empty string (6 ms)
      âœ“ should return the default value when the environment variable is undefined (1 ms)
      âœ“ should return undefined when no default value is provided and the environment variable is not set (1 ms)
    isCI
      âœ“ should return false when no CI environment variables are set (5 ms)
      âœ“ should return true when CI is set to 'true' (1 ms)
      âœ“ should return false when CI is set to 'false' (10 ms)
      âœ“ should return true when GITHUB_ACTIONS is set to 'true'
      âœ“ should return false when GITHUB_ACTIONS is set to 'false' (7 ms)
      âœ“ should return true when TRAVIS is set to 'true' (1 ms)
      âœ“ should return false when TRAVIS is set to 'false' (3 ms)
      âœ“ should return true when CIRCLECI is set to 'true' (3 ms)
      âœ“ should return false when CIRCLECI is set to 'false' (1 ms)
      âœ“ should return true when JENKINS is set to 'true'
      âœ“ should return false when JENKINS is set to 'false' (2 ms)
      âœ“ should return true when GITLAB_CI is set to 'true' (1 ms)
      âœ“ should return false when GITLAB_CI is set to 'false' (1 ms)
      âœ“ should return true when APPVEYOR is set to 'true' (1 ms)
      âœ“ should return false when APPVEYOR is set to 'false' (2 ms)
      âœ“ should return true when CODEBUILD_BUILD_ID is set to 'true'
      âœ“ should return false when CODEBUILD_BUILD_ID is set to 'false' (20 ms)
      âœ“ should return true when TF_BUILD is set to 'true' (4 ms)
      âœ“ should return false when TF_BUILD is set to 'false'
      âœ“ should return true when BITBUCKET_COMMIT is set to 'true' (1 ms)
      âœ“ should return false when BITBUCKET_COMMIT is set to 'false'
      âœ“ should return true when BUDDY is set to 'true' (1 ms)
      âœ“ should return false when BUDDY is set to 'false'
      âœ“ should return true when BUILDKITE is set to 'true'
      âœ“ should return false when BUILDKITE is set to 'false' (4 ms)
      âœ“ should return true when TEAMCITY_VERSION is set to 'true'
      âœ“ should return false when TEAMCITY_VERSION is set to 'false' (1 ms)
      âœ“ should return true if any CI environment variable is set to true (1 ms)

PASS test/providers/http.test.ts
  HttpProvider
    âœ“ should call the API and return the response (61 ms)
    âœ“ should handle API call errors (176 ms)
    âœ“ should use custom method/headers/queryParams (17 ms)
    âœ“ should handle response transform type: (data)=>data.custom (4 ms)
    âœ“ should handle response transform type: json.result (11 ms)
    âœ“ should handle response transform type: text (2 ms)
    âœ“ should correctly render Nunjucks templates in config (14 ms)
    âœ“ should throw an error when creating HttpProvider with invalid config (102 ms)
    âœ“ should return provider id and string representation (1 ms)
    âœ“ should handle GET requests with query parameters (10 ms)
    âœ“ should use default parser when no parser is provided (12 ms)
    âœ“ should handle response transform returning an object (9 ms)
    âœ“ should default to application/json for content-type if body is an object (8 ms)
    âœ“ should default to application/x-www-form-urlencoded for content-type if body is not an object (15 ms)
    âœ“ should throw an error if the body is an object and the content-type is not application/json (2 ms)
    âœ“ should respect maxRetries configuration (9 ms)
    raw request
      âœ“ should handle a basic GET raw request (36 ms)
      âœ“ should handle a POST raw request with body and variable substitution (13 ms)
      âœ“ should load raw request from file if file:// prefix is used (12 ms)
      âœ“ should throw an error for invalid raw requests (17 ms)
    processJsonBody
      âœ“ should process simple key-value pairs (8 ms)
      âœ“ should process nested objects (1 ms)
      âœ“ should process arrays (12 ms)
      âœ“ should handle empty vars (1 ms)
      âœ“ should handle complex nested structures (12 ms)
    createtransformResponse
      âœ“ should handle function parser (2 ms)
      âœ“ should handle file:// parser with JavaScript file (1 ms)
      âœ“ should throw error for unsupported parser type (13 ms)
      âœ“ should handle string parser (2 ms)
      âœ“ should handle file:// parser with specific function name (6 ms)
      âœ“ should throw error for malformed file:// parser (4 ms)
      âœ“ should return default parser when no parser is provided
      âœ“ should handle response transform file with default export (1 ms)
    getDefaultHeaders
      âœ“ should return empty object for GET requests (1 ms)
      âœ“ should return application/json for object body (1 ms)
      âœ“ should return application/x-www-form-urlencoded for string body
    validateContentTypeAndBody
      âœ“ should not throw for valid content-type and body (8 ms)
      âœ“ should throw for non-json content-type with object body (2 ms)
    getHeaders
      âœ“ should combine default headers with config headers (6 ms)
      âœ“ should render template strings in headers (1 ms)
    Content-Type and body handling
      âœ“ should render string body when content-type is not set (14 ms)
      âœ“ should default to JSON when content-type is not set and body is an object (11 ms)
      âœ“ should render object body when content-type is application/json (2 ms)
      âœ“ should render a stringified object body when content-type is application/json (26 ms)
      âœ“ should render nested object variables correctly when content-type is application/json (57 ms)
      âœ“ should render nested array variables correctly when content-type is application/json (9 ms)
    deprecated responseParser handling
      âœ“ should use responseParser when transformResponse is not set (2 ms)
      âœ“ should prefer transformResponse over responseParser when both are set (13 ms)
      âœ“ should handle string-based responseParser when transformResponse is not set (2 ms)
  createTransformRequest
    âœ“ should return identity function when no transform specified
    âœ“ should handle string templates (8 ms)
    âœ“ should handle errors in function-based transform (3 ms)
    âœ“ should handle errors in file-based transform (10 ms)
    âœ“ should handle errors in string template transform (2 ms)
    âœ“ should handle function-based request transform (12 ms)
    âœ“ should throw error for unsupported transform type (2 ms)
    âœ“ should include filename in error for file-based transform errors (9 ms)
    âœ“ should handle errors in string template rendering (3 ms)
  determineRequestBody
    âœ“ should merge parsed prompt object with config body when content type is JSON (1 ms)
    âœ“ should process JSON body with variables when parsed prompt is not an object (1 ms)
    âœ“ should process text body when content type is not JSON (1 ms)
    âœ“ should handle nested JSON structures (9 ms)
    âœ“ should handle undefined config body with object prompt (1 ms)
    âœ“ should handle array config body (1 ms)
  constructor validation
    âœ“ should validate config using Zod schema (2 ms)
    âœ“ should require body or GET method (14 ms)
  content type handling
    âœ“ should handle JSON content type with object body (10 ms)
    âœ“ should handle non-JSON content type with string body (2 ms)
    âœ“ should throw error for object body with non-JSON content type (6 ms)
  request transformation
    âœ“ should handle string-based request transform (5 ms)
    âœ“ should handle function-based request transform (5 ms)
  response handling
    âœ“ should handle successful JSON response (1 ms)
    âœ“ should handle non-JSON response (5 ms)
    âœ“ should include debug information when requested (6 ms)
  session handling
    âœ“ should extract session ID from headers when configured (2 ms)
  error handling
    âœ“ should throw error for responses that fail validateStatus check (4 ms)
    âœ“ should throw session parsing errors (3 ms)
    âœ“ should throw error for raw request with non-200 response (2 ms)
  validateStatus
    default behavior
      âœ“ should accept all status codes when validateStatus is not provided (2 ms)
    string-based validators
      âœ“ should handle expression format (2 ms)
      âœ“ should handle arrow function format with parameter (4 ms)
      âœ“ should handle arrow function format without parameter (3 ms)
      âœ“ should handle regular function format (3 ms)
    error handling
      âœ“ should handle malformed string expressions (2 ms)
      âœ“ should throw error for malformed file-based validator (2 ms)
      âœ“ should throw error for unsupported validator type (1 ms)
    file-based validators
      âœ“ should handle file-based validateStatus (2 ms)
      âœ“ should handle file-based validateStatus with specific function (2 ms)
  session parser
    âœ“ should handle string-based session parser (2 ms)
    âœ“ should throw error for unsupported session parser type (1 ms)
  transform response error handling
    âœ“ should handle errors in response transform function (2 ms)
    âœ“ should handle errors in string-based transform (2 ms)
  arrow function parsing in transformResponse
    âœ“ should handle arrow function with explicit body (1 ms)
    âœ“ should handle regular function with explicit body (1 ms)
    âœ“ should handle arrow function with implicit return (1 ms)
    âœ“ should handle arrow function with context parameter (1 ms)
    âœ“ should handle simple expression without function (1 ms)
    âœ“ should handle multiline arrow function (9 ms)
  transform request error handling
    âœ“ should handle errors in string-based request transform (6 ms)
    âœ“ should throw error for malformed file-based request transform (1 ms)
  status validator error handling
    âœ“ should throw error for invalid status validator expression (2 ms)
    âœ“ should throw error for malformed file-based validator (1 ms)
    âœ“ should throw error for unsupported validator type (1 ms)
  string-based validators
    âœ“ should handle expression format (3 ms)
    âœ“ should handle arrow function format with parameter (3 ms)
    âœ“ should handle arrow function format without parameter (3 ms)
    âœ“ should handle regular function format (2 ms)
    âœ“ should handle malformed string expressions (2 ms)
  RSA signature authentication
    âœ“ should generate and include signature in vars (19 ms)
    âœ“ should reuse cached signature when within validity period (12 ms)
    âœ“ should regenerate signature when expired (7 ms)
    âœ“ should use custom signature data template (10 ms)
    âœ“ should support using privateKey directly instead of privateKeyPath (14 ms)
  createSessionParser
    âœ“ should return empty string when no parser is provided
    âœ“ should handle function parser (5 ms)
    âœ“ should handle header path expression (1 ms)
    âœ“ should handle body path expression
    âœ“ should handle file:// parser (1 ms)
    âœ“ should handle file:// parser with specific function (1 ms)
    âœ“ should throw error for malformed file:// parser (12 ms)
    âœ“ should handle complex body path expression (1 ms)

PASS test/redteam/extraction/util.test.ts
  fetchRemoteGeneration
    âœ“ should fetch remote generation for purpose task (15 ms)
    âœ“ should fetch remote generation for entities task (7 ms)
    âœ“ should throw an error when fetchWithCache fails (25 ms)
    âœ“ should throw an error when response parsing fails (16 ms)
    âœ“ should use custom remote generation URL when provided (6 ms)
  RedTeamGenerationResponse
    âœ“ should validate correct response structure (3 ms)
    âœ“ should throw error for invalid response structure (12 ms)
    âœ“ should validate response with string result (1 ms)
    âœ“ should validate response with array result (8 ms)
  Extraction Utils
    callExtraction
      âœ“ should call API with formatted chat message and process output correctly (1 ms)
      âœ“ should throw an error if API call fails (1 ms)
      âœ“ should throw an error if output is not a string (9 ms)
      âœ“ should handle empty string output (1 ms)
      âœ“ should handle null output (1 ms)
      âœ“ should handle undefined output (21 ms)
    formatPrompts
      âœ“ should format prompts correctly (2 ms)

PASS test/redteam/providers/shared.test.ts (5.158 s)
  shared redteam provider utilities
    RedteamProviderManager
      âœ“ creates default OpenAI provider when no provider specified (17 ms)
      âœ“ clears cached providers (4 ms)
      âœ“ loads provider from string identifier (3 ms)
      âœ“ loads provider from provider options (1 ms)
      âœ“ uses small model when preferSmallModel is true (3 ms)
      âœ“ sets response_format to json_object when jsonOnly is true (2 ms)
      âœ“ uses provider from cliState if available (1 ms)
      âœ“ sets and reuses providers (2 ms)
      âœ“ handles thrown errors in getTargetResponse (2 ms)
    getTargetResponse
      âœ“ returns successful response with string output (1 ms)
      âœ“ passes through context and options (2 ms)
      âœ“ stringifies non-string output (1 ms)
      âœ“ handles provider error response (1 ms)
      âœ“ respects provider delay for non-cached responses (1 ms)
      âœ“ skips delay for cached responses (1 ms)
      âœ“ throws error when neither output nor error is set (82 ms)
      âœ“ uses default tokenUsage when not provided (1 ms)
    messagesToRedteamHistory
      âœ“ converts valid messages to redteamHistory format (1 ms)
      âœ“ handles empty messages array (1 ms)
      âœ“ handles messages with missing content (1 ms)
      âœ“ handles malformed messages gracefully
      âœ“ handles non-array input gracefully
      âœ“ skips incomplete message pairs (15 ms)

PASS test/guardrails.test.ts
  guardrails
    guard
      âœ“ should make a request to the guard endpoint (6 ms)
      âœ“ should return the parsed guard result
      âœ“ should handle API errors (24 ms)
      âœ“ should handle empty API response (3 ms)
    pii
      âœ“ should make a request to the pii endpoint (1 ms)
      âœ“ should return the parsed PII result (1 ms)
      âœ“ should handle API errors (2 ms)
    harm
      âœ“ should make a request to the harm endpoint (1 ms)
      âœ“ should return the parsed harm result (1 ms)
      âœ“ should handle API errors (2 ms)
    response structure
      âœ“ should have correct guard result structure (4 ms)
      âœ“ should have correct PII result structure with payload (2 ms)

PASS test/redteam/providers/pandamonium.test.ts
  RedteamPandamoniumProvider
    âœ“ should terminate loop when no test cases returned from /next endpoint (61 ms)
    âœ“ should call target provider with test cases and aggregate results, triggering success (43 ms)
    âœ“ should handle error during pandamonium run gracefully (9 ms)

PASS test/types.test.ts
  AssertionSchema
    âœ“ should validate a basic assertion (9 ms)
    âœ“ should validate an assertion with all optional fields
    âœ“ should validate all base assertion types (32 ms)
    âœ“ should validate "not-" prefixed assertion types (8 ms)
    âœ“ should validate assertions with function values (1 ms)
    âœ“ should validate assertions with array values
    âœ“ should accept valid "not-" prefixed assertion types (1 ms)
  VarsSchema
    âœ“ should validate and transform various types of values (22 ms)
    âœ“ should throw an error for invalid types (134 ms)
  isGradingResult
    âœ“ should correctly identify valid GradingResult objects (20 ms)
    âœ“ should correctly identify invalid GradingResult objects (2 ms)
  TestSuiteConfigSchema
    âœ“ should find configuration files (6 ms)
    âœ“ should validate examples/websockets/promptfooconfig.yaml (39 ms)
    âœ“ should validate examples/watsonx/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/voyage-embeddings/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/vars-referencing-vars/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/transform-file/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/tool-use/promptfooconfig.yaml (5 ms)
    âœ“ should validate examples/test-markdown/promptfooconfig.yaml (7 ms)
    âœ“ should validate examples/tau-simulated-user/promptfooconfig.yaml (18 ms)
    âœ“ should validate examples/summarization/promptfooconfig.yaml (7 ms)
    âœ“ should validate examples/structured-outputs-config/promptfooconfig.yaml (9 ms)
    âœ“ should validate examples/store-and-reuse-outputs/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/sql-validation/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/simple-test/promptfooconfig.yaml (12 ms)
    âœ“ should validate examples/simple-csv/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/simple-cli/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/separate-test-configs/promptfooconfig.yaml (9 ms)
    âœ“ should validate examples/self-grading/promptfooconfig.yaml (14 ms)
    âœ“ should validate examples/select-best-example/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/replicate-llama2/promptfooconfig.yaml (16 ms)
    âœ“ should validate examples/replicate-lifeboat/promptfooconfig.yaml (9 ms)
    âœ“ should validate examples/redteam-travel-agent/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/redteam-starter/promptfooconfig.yaml (16 ms)
    âœ“ should validate examples/redteam-rag/promptfooconfig.yaml (11 ms)
    âœ“ should validate examples/redteam-provider-override/promptfooconfig.yaml (9 ms)
    âœ“ should validate examples/redteam-ollama/promptfooconfig.yaml (13 ms)
    âœ“ should validate examples/redteam-minimal/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/redteam-langchain/promptfooconfig.yaml (13 ms)
    âœ“ should validate examples/redteam-intent-sequence/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/redteam-deepseek-foundation/promptfooconfig.yaml (9 ms)
    âœ“ should validate examples/redteam-deepseek/promptfooconfig.yaml (12 ms)
    âœ“ should validate examples/redteam-dalle/promptfooconfig.yaml (22 ms)
    âœ“ should validate examples/redteam-custom-strategy/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/redteam-chatbot/promptfooconfig.yaml (13 ms)
    âœ“ should validate examples/redteam-bestOfN-strategy/promptfooconfig.yaml (12 ms)
    âœ“ should validate examples/redteam-beavertails/promptfooconfig.yaml (17 ms)
    âœ“ should validate examples/rag-full/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/rag-eval/promptfooconfig.yaml (14 ms)
    âœ“ should validate examples/python-test-cases/promptfooconfig.yaml (4 ms)
    âœ“ should validate examples/python-provider/promptfooconfig.yaml (10 ms)
    âœ“ should validate examples/python-assert-inline/promptfooconfig.yaml (29 ms)
    âœ“ should validate examples/python-assert-external/promptfooconfig.yaml (14 ms)
    âœ“ should validate examples/prompts-per-model/promptfooconfig.yaml (16 ms)
    âœ“ should validate examples/prompt-labels/promptfooconfig.yaml (12 ms)
    âœ“ should validate examples/phi-vs-llama/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/perplexity.ai-example/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/pdf-variables/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/openai-vision/promptfooconfig.yaml (5 ms)
    âœ“ should validate examples/openai-tools-call/promptfooconfig.yaml (12 ms)
    âœ“ should validate examples/openai-structured-output/promptfooconfig.yaml (22 ms)
    âœ“ should validate examples/openai-multiline-yaml/promptfooconfig.yaml (10 ms)
    âœ“ should validate examples/openai-function-call/promptfooconfig.yaml (11 ms)
    âœ“ should validate examples/openai-eval-factuality/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/openai-dalle-images/promptfooconfig.yaml (16 ms)
    âœ“ should validate examples/openai-chat-history/promptfooconfig.yaml (13 ms)
    âœ“ should validate examples/ollama-comparison/promptfooconfig.yaml (13 ms)
    âœ“ should validate examples/nunjucks-custom-filters/promptfooconfig.yaml (7 ms)
    âœ“ should validate examples/node-module-package/promptfooconfig.yaml (1 ms)
    âœ“ should validate examples/named-metrics/promptfooconfig.yaml (7 ms)
    âœ“ should validate examples/multishot/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/multiple-turn-conversation/promptfooconfig.yaml (4 ms)
    âœ“ should validate examples/multiple-translations-scenarios/promptfooconfig.yaml (9 ms)
    âœ“ should validate examples/multiple-translations/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/moderation/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/mistral-llama-comparison/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/mistral/promptfooconfig.yaml (4 ms)
    âœ“ should validate examples/lm-studio/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/llama-gpt-comparison/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/llama-cpp/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/langchain-python/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/json-output/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/javascript-test-cases/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/javascript-assert-external/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/image-classification/promptfooconfig.yaml (7 ms)
    âœ“ should validate examples/ibm-granite-vs-llama/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/huggingface-similarity/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/huggingface-pii/promptfooconfig.yaml (4 ms)
    âœ“ should validate examples/huggingface-inference-endpoint/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/huggingface-hate-speech-detection/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/huggingface-dataset/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/http-provider-auth-signature/promptfooconfig.yaml (4 ms)
    âœ“ should validate examples/http-provider/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/headless-browser/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/harmbench/promptfooconfig.yaml (9 ms)
    âœ“ should validate examples/groq/promptfooconfig.yaml (7 ms)
    âœ“ should validate examples/gpt-4o-vs-4o-mini/promptfooconfig.yaml (18 ms)
    âœ“ should validate examples/gpt-4o-temperature-comparison/promptfooconfig.yaml (16 ms)
    âœ“ should validate examples/google-vertex/promptfooconfig.yaml (15 ms)
    âœ“ should validate examples/google-sheets/promptfooconfig.yaml (1 ms)
    âœ“ should validate examples/google-aistudio-gemini/promptfooconfig.yaml (11 ms)
    âœ“ should validate examples/golang-provider/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/gemma-vs-mistral/promptfooconfig.yaml (43 ms)
    âœ“ should validate examples/gemma-vs-llama/promptfooconfig.yaml (16 ms)
    âœ“ should validate examples/g-eval/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/f-score/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/external-provider-config/promptfooconfig.yaml (1 ms)
    âœ“ should validate examples/extension-api/promptfooconfig.yaml (7 ms)
    âœ“ should validate examples/errors-vs-failures/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/dynamic-var/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/docker-code-generation-sandbox/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/deepseek-r1-vs-openai-o1/promptfooconfig.yaml (5 ms)
    âœ“ should validate examples/dbrx-benchmark/promptfooconfig.yaml (7 ms)
    âœ“ should validate examples/cyberseceval/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/custom-provider-typescript/promptfooconfig.yaml (8 ms)
    âœ“ should validate examples/custom-provider-mjs/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/custom-provider-embeddings/promptfooconfig.yaml (14 ms)
    âœ“ should validate examples/custom-provider/promptfooconfig.yaml (1 ms)
    âœ“ should validate examples/custom-prompt-function/promptfooconfig.yaml (22 ms)
    âœ“ should validate examples/custom-grading-prompt/promptfooconfig.yaml (4 ms)
    âœ“ should validate examples/custom-grader-csv/promptfooconfig.yaml (1 ms)
    âœ“ should validate examples/cohere-benchmark/promptfooconfig.yaml (17 ms)
    âœ“ should validate examples/cohere/promptfooconfig.yaml (9 ms)
    âœ“ should validate examples/claude-vs-gpt-image/promptfooconfig.yaml (13 ms)
    âœ“ should validate examples/claude-vs-gpt/promptfooconfig.yaml (32 ms)
    âœ“ should validate examples/claude-vision/promptfooconfig.yaml (25 ms)
    âœ“ should validate examples/azure-openai-assistant/promptfooconfig.yaml (36 ms)
    âœ“ should validate examples/azure-openai/promptfooconfig.yaml (6 ms)
    âœ“ should validate examples/assistant-cli/promptfooconfig.yaml (1 ms)
    âœ“ should validate examples/amazon-bedrock/promptfooconfig.yaml (32 ms)
    âœ“ should validate examples/adaline-gateway/adaline-vision-base64/promptfooconfig.yaml (19 ms)
    âœ“ should validate examples/adaline-gateway/adaline-vision/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/adaline-gateway/adaline-tool-call/promptfooconfig.yaml (28 ms)
    âœ“ should validate examples/adaline-gateway/adaline-structured-output/promptfooconfig.yaml (15 ms)
    âœ“ should validate examples/adaline-gateway/adaline-openai-format/promptfooconfig.yaml (10 ms)
    âœ“ should validate examples/adaline-gateway/adaline-multi-provider/promptfooconfig.yaml (2 ms)
    âœ“ should validate examples/adaline-gateway/adaline-eval-factuality/promptfooconfig.yaml (13 ms)
    âœ“ should validate examples/adaline-gateway/adaline-embedding-similarity/promptfooconfig.yaml (3 ms)
    âœ“ should validate examples/adaline-gateway/adaline-chat-history/promptfooconfig.yaml (14 ms)
  TestSuiteSchema
    extensions field
      âœ“ should accept valid Python extension paths (5 ms)
      âœ“ should accept valid JavaScript extension paths (1 ms)
      âœ“ should reject invalid extension path: path/to/file.py:function_name (Missing file:// prefix) (13 ms)
      âœ“ should reject invalid extension path: file://path/to/file.txt:function_name (Invalid file extension) (2 ms)
      âœ“ should reject invalid extension path: file://path/to/file.py (Missing function name)
      âœ“ should reject invalid extension path: file://path/to/file.py: (Empty function name) (23 ms)
      âœ“ should reject invalid extension path: file://:function_name (Missing file path) (2 ms)
      âœ“ should reject invalid extension path: file://path/to/file.py:function_name:extra_arg (Extra argument) (69 ms)
      âœ“ should allow extensions field to be optional (1 ms)
      âœ“ should allow an empty array of extensions (1 ms)

PASS test/globalConfig/accounts.test.ts
  accounts
    getUserEmail
      âœ“ should return email from global config (1 ms)
      âœ“ should return null if no email in config (1 ms)
    setUserEmail
      âœ“ should write email to global config (6 ms)
    getAuthor
      âœ“ should return env var if set (9 ms)
      âœ“ should fall back to user email if no env var
      âœ“ should return null if no author found (1 ms)
    promptForEmailUnverified
      âœ“ should use CI email if in CI environment (1 ms)
      âœ“ should not prompt for email if already set (12 ms)
      âœ“ should prompt for email and save valid input (2 ms)
      âœ“ should save consent after successful email input (1 ms)
      email validation
        âœ“ should reject invalid email formats with error message (29 ms)
        âœ“ should accept valid email formats with true (7 ms)
    checkEmailStatusOrExit
      âœ“ should use CI email when in CI environment (15 ms)
      âœ“ should use user email when not in CI environment (1 ms)
      âœ“ should exit if limit exceeded (1 ms)
      âœ“ should handle fetch errors (2 ms)

PASS test/evaluatorHelpers.test.ts
  renderPrompt
    âœ“ should render a prompt with a single variable (64 ms)
    âœ“ should render a JSON prompt (18 ms)
    âœ“ should render a JSON prompt and escape the var string (2 ms)
    âœ“ should render a JSON prompt with nested JSON (22 ms)
    âœ“ should load external yaml files in renderPrompt (25 ms)
    âœ“ should load external js files in renderPrompt and execute the exported function (18 ms)
    âœ“ should load external js package in renderPrompt and execute the exported function (16 ms)
    âœ“ should load external json files in renderPrompt and parse the JSON content (48 ms)
    âœ“ should load external yaml files in renderPrompt and parse the YAML content (24 ms)
  resolveVariables
    âœ“ should replace placeholders with corresponding variable values (1 ms)
    âœ“ should handle nested variable substitutions
    âœ“ should not modify variables without placeholders (5 ms)
    âœ“ should not fail if a variable is not found (4 ms)
    âœ“ should not fail for unresolved placeholders (1 ms)
  runExtensionHook
    âœ“ should not call transform if extensions array is empty (1 ms)
    âœ“ should not call transform if extensions is undefined (9 ms)
    âœ“ should call transform for each extension (29 ms)
    âœ“ should throw an error if an extension is not a string (76 ms)

PASS test/providers/packageParser.test.ts
  isPackagePath
    âœ“ should return true for package paths (1 ms)
    âœ“ should return false for non-package paths
  loadFromPackage
    âœ“ should successfully parse a valid package (16 ms)
    âœ“ should throw an error for invalid provider format (176 ms)
    âœ“ should throw an error if package is not found (19 ms)
    âœ“ should handle nested provider names (1 ms)
  parsePackageProvider
    âœ“ should successfully parse a valid package provider (9 ms)
    âœ“ should throw an error for invalid provider format (2 ms)
    âœ“ should throw an error if package is not found (15 ms)
    âœ“ should handle nested provider names (3 ms)
    âœ“ should pass options to the provider constructor (5 ms)

PASS test/util/exportToFile/index.test.ts
  exportToFile utils
    getHeaderForTable
      âœ“ should extract vars from defaultTest (4 ms)
      âœ“ should extract vars from tests array (1 ms)
      âœ“ should extract vars from scenarios
      âœ“ should handle empty config (5 ms)
    convertEvalResultToTableCell
      âœ“ should handle successful assertion result (1 ms)
      âœ“ should handle failed assertion result
      âœ“ should handle error without assertion (4 ms)
    convertTestResultsToTableRow
      âœ“ should convert results to table row (2 ms)
      âœ“ should handle complex var values

PASS test/assertions/bleu.test.ts
  BLEU score calculation
    âœ“ identical sentences should have BLEU score close to, but not equal to one due to smoothing (2 ms)
    âœ“ completely different sentences should have very low but non-zero BLEU score due to smoothing (1 ms)
    âœ“ partially matching sentences should have score between 0 and 1
    âœ“ should handle custom weights (1 ms)
    âœ“ should handle empty or single word sentences
    âœ“ should handle sentences with different lengths (1 ms)
    âœ“ should handle multiple references and take best matching score (1 ms)
    âœ“ should use closest reference length for brevity penalty (1 ms)
    âœ“ should throw error for empty reference array (23 ms)
    âœ“ should throw error for invalid weights (2 ms)
    âœ“ should throw error for wrong number of weights (1 ms)
    âœ“ should handle multiple references with varying lengths (1 ms)
  handleBleuScore
    âœ“ should handle string reference with passing score (2 ms)
    âœ“ should handle array of references (1 ms)
    âœ“ should handle custom threshold (7 ms)
    âœ“ should handle inverse assertion (1 ms)
    âœ“ should use default threshold of 0.5

PASS test/assertions/javascript.test.ts (5.683 s)
  JavaScript file references
    âœ“ should handle JavaScript file reference with function name (86 ms)
    âœ“ should handle default export when no function name specified (5 ms)
    âœ“ should handle default export object with function (6 ms)
    âœ“ should pass when the javascript assertion passes (12 ms)
    âœ“ should pass a score through when the javascript returns a number (4 ms)
    âœ“ should pass when javascript returns an output string that is smaller than the maximum size threshold (3 ms)
    âœ“ should fail when javascript returns an output string that is larger than the maximum size threshold (4 ms)
    âœ“ should pass when javascript returns a number above threshold (3 ms)
    âœ“ should fail when javascript returns a number below threshold (4 ms)
    âœ“ should set score when javascript returns false (2 ms)
    âœ“ should fail when the javascript assertion fails (2 ms)
    âœ“ should pass when javascript function assertion passes - with vars (5 ms)
    âœ“ should fail when the javascript does not match vars (4 ms)
    âœ“ should pass when the function returns pass (1 ms)
    âœ“ should fail when the function returns fail (1 ms)
    âœ“ should pass when the multiline javascript assertion passes (3 ms)
    âœ“ should pass when the multiline javascript assertion fails (2 ms)
    âœ“ should pass when the file:// assertion with .js file returns a boolean (3 ms)
    âœ“ should pass when the file:// assertion with .js file returns a number (2 ms)
    âœ“ should pass when the file:// assertion with .js file returns a GradingResult (3 ms)
    âœ“ should pass when the file:// assertion with .js file returns a boolean (3 ms)
    âœ“ should pass when the file:// assertion with .js file returns a number (4 ms)
    âœ“ should pass when the file:// assertion with .js file returns a GradingResult (2 ms)
    âœ“ should pass when the file:// assertion with .js file returns a boolean Promise (2 ms)
    âœ“ should pass when assertion is a package path (2 ms)
    âœ“ should pass when assertion is a package path (3 ms)
    âœ“ should pass when assertion is a package path (2 ms)
    âœ“ should pass when assertion is a package path (2 ms)
    âœ“ should pass when assertion is a package path (1 ms)
    âœ“ should pass when assertion is a package path (2 ms)
    âœ“ should pass when assertion is a package path (2 ms)
    âœ“ should resolve js paths relative to the configuration file (2 ms)

PASS test/util/config/default.test.ts
  loadDefaultConfig
    âœ“ should return empty config when no config file is found (31 ms)
    âœ“ should return the first valid config file found (27 ms)
    âœ“ should stop checking extensions after finding a valid config (1 ms)
    âœ“ should use provided directory when specified (1 ms)
    âœ“ should use custom config name when provided (20 ms)
    âœ“ should use different caches for different config names (2 ms)
    âœ“ should use different caches for different directories (18 ms)
    âœ“ should use cache for subsequent calls with same parameters (1 ms)
    âœ“ should handle errors when reading config files (57 ms)
    âœ“ should handle various config names (15 ms)
    âœ“ should handle interaction between configName and directory (1 ms)

PASS test/providers/bedrock.test.ts (6.138 s)
  AwsBedrockGenericProvider
    âœ“ should create Bedrock instance without proxy settings (15 ms)
    âœ“ should create Bedrock instance with credentials (3 ms)
    âœ“ should not include credentials if not provided (2 ms)
    âœ“ should respect AWS_BEDROCK_MAX_RETRIES environment variable (2 ms)
    BEDROCK_MODEL CLAUDE_MESSAGES
      âœ“ should include tools and tool_choice in params when provided (5 ms)
      âœ“ should not include tools and tool_choice in params when not provided (1 ms)
      âœ“ should include specific tool_choice when provided (2 ms)
      âœ“ should handle JSON message array with image content (1 ms)
      âœ“ should handle JSON message array with system message and image content (1 ms)
      âœ“ should convert lone system message to user message (2 ms)
    BEDROCK_MODEL AI21
      âœ“ should include AI21-specific parameters (2 ms)
      âœ“ should use default values when config is not provided (1 ms)
      âœ“ should handle output correctly (1 ms)
      âœ“ should throw an error for API errors (311 ms)
    getCredentials
      âœ“ should return credentials if accessKeyId and secretAccessKey are provided (7 ms)
      âœ“ should return undefined if accessKeyId or secretAccessKey is missing (1 ms)
      âœ“ should return credentials when accessKeyId and secretAccessKey are provided (1 ms)
      âœ“ should return SSO credential provider when profile is specified (10 ms)
      âœ“ should return undefined when no credentials are provided (1 ms)
  addConfigParam
    âœ“ should add config value if provided (1 ms)
    âœ“ should add env value if config value is not provided (1 ms)
    âœ“ should add default value if neither config nor env value is provided (2 ms)
    âœ“ should prioritize config value over env and default values (1 ms)
    âœ“ should prioritize env value over default value if config value is not provided (1 ms)
    âœ“ should parse env value if default value is a number
    âœ“ should handle undefined config, env, and default values gracefully (1 ms)
    âœ“ should correctly parse non-number string values
    âœ“ should correctly parse empty string values (6 ms)
    âœ“ should handle env value not set (1 ms)
    âœ“ should handle config values that are objects
    âœ“ should handle config values that are arrays (1 ms)
    âœ“ should handle special characters in env values
  parseValue
    âœ“ should return the original value if defaultValue is not a number
    âœ“ should return parsed float value if defaultValue is a number (1 ms)
    âœ“ should return NaN for non-numeric strings if defaultValue is a number (1 ms)
    âœ“ should return 0 for an empty string if defaultValue is a number
    âœ“ should return null for a null value if defaultValue is not a number (1 ms)
    âœ“ should return undefined for an undefined value if defaultValue is not a number
  llama
    getLlamaModelHandler
      âœ“ should throw an error for unsupported LLAMA version (20 ms)
      âœ“ should handle output correctly (1 ms)
      LLAMA2
        âœ“ should generate correct prompt for a single user message (12 ms)
        âœ“ should handle a system message followed by a user message
        âœ“ should handle multiple turns of conversation (1 ms)
      LLAMA3
        âœ“ should generate correct prompt for a single user message (1 ms)
        âœ“ should handle a system message followed by a user message (1 ms)
        âœ“ should handle multiple turns of conversation (9 ms)
      LLAMA3_1
        âœ“ should generate correct prompt for a single user message (5 ms)
      LLAMA3_2
        âœ“ should generate correct prompt for a single user message (1 ms)
        âœ“ should use max_gen_len parameter
      LLAMA3_3
        âœ“ should generate correct prompt for a single user message (16 ms)
        âœ“ should use max_gen_len parameter (1 ms)
    formatPromptLlama2Chat
      âœ“ should format a single user message correctly (1 ms)
      âœ“ should handle a system message followed by a user message (1 ms)
      âœ“ should handle a system message, user message, and assistant response
      âœ“ should handle multiple turns of conversation (1 ms)
      âœ“ should handle only a system message correctly (1 ms)
    formatPromptLlama3Instruct
      âœ“ should format a single user message correctly
      âœ“ should format multiple messages correctly (1 ms)
      âœ“ should handle system messages correctly (1 ms)
  BEDROCK_MODEL AMAZON_NOVA
    âœ“ should format system message correctly when using JSON array input (9 ms)
    âœ“ should handle messages without system prompt (1 ms)
    âœ“ should handle complex message content arrays (8 ms)
    âœ“ should handle invalid JSON gracefully (1 ms)

PASS test/providers/vertex.test.ts
  VertexChatProvider.callGeminiApi
    âœ“ should call the Gemini API and return the response (60 ms)
    âœ“ should return cached response if available (2 ms)
    âœ“ should handle API call errors (5 ms)
    âœ“ should handle API response errors (2 ms)
  maybeCoerceToGeminiFormat
    âœ“ should return unmodified content if it matches GeminiFormat (19 ms)
    âœ“ should coerce OpenAI chat format to GeminiFormat (9 ms)
    âœ“ should coerce string input to GeminiFormat (1 ms)
    âœ“ should handle system messages and create systemInstruction (9 ms)
    âœ“ should log a warning and return the input for unknown formats (11 ms)

PASS test/providers/azure.test.ts (6.058 s)
  maybeEmitAzureOpenAiWarning
    âœ“ should not emit warning when no Azure providers are used (61 ms)
    âœ“ should not emit warning when Azure provider is used alone, but no model graded eval (1 ms)
    âœ“ should emit warning when Azure provider is used alone, but with model graded eval (15 ms)
    âœ“ should emit warning when Azure provider used with non-OpenAI provider (1 ms)
    âœ“ should not emit warning when Azure providers are used with a default provider set (13 ms)
    âœ“ should not emit warning when both Azure and OpenAI providers are used (1 ms)
  AzureOpenAiGenericProvider
    getApiBaseUrl
      âœ“ should return apiBaseUrl if set (9 ms)
      âœ“ should return apiBaseUrl without trailing slash if set (1 ms)
      âœ“ should construct URL from apiHost without protocol (1 ms)
      âœ“ should remove protocol from apiHost if present (12 ms)
      âœ“ should remove trailing slash from apiHost if present (1 ms)
      âœ“ should return undefined if neither apiBaseUrl nor apiHost is set (2 ms)
  AzureOpenAiChatCompletionProvider
    config merging
      âœ“ should use provider config when no prompt config exists (32 ms)
      âœ“ should merge prompt config with provider config (5 ms)
      âœ“ should handle undefined prompt config (2 ms)
      âœ“ should handle empty prompt config (5 ms)
      âœ“ should handle complex nested config merging (2 ms)
      âœ“ should handle json_schema response format (12 ms)
      âœ“ should render variables in response format (8 ms)
    response handling
      âœ“ should parse JSON response with json_schema format when finish_reason is not content_filter (11 ms)
      âœ“ should handle content_filter finish_reason (2 ms)
      âœ“ should handle API errors (2 ms)
      âœ“ should handle invalid JSON response (1 ms)
      âœ“ should handle tool calls in response (2 ms)
      âœ“ should handle content filter error response (1 ms)
    structured outputs
      âœ“ should parse JSON response when prompt config specifies json_object format (2 ms)
      âœ“ should handle invalid JSON when response format is specified (2 ms)
      âœ“ should use correct API URL based on datasources config from prompt (1 ms)
  AzureCompletionProvider
    âœ“ should handle basic completion with caching (5 ms)

PASS test/integrations/huggingfaceDatasets.test.ts
  huggingfaceDatasets
    âœ“ should fetch and parse dataset with default parameters (45 ms)
    âœ“ should handle custom query parameters (2 ms)
    âœ“ should handle pagination (3 ms)
    âœ“ should handle API errors (90 ms)
    âœ“ should respect user-specified limit parameter (11 ms)
    âœ“ should handle limit larger than page size (19 ms)

PASS test/assertions/openai.test.ts (6.526 s)
  OpenAI assertions
    is-valid-openai-function-call assertion
      âœ“ should pass for a valid function call with correct arguments (206 ms)
      âœ“ should pass for a nested function_call output (13 ms)
      âœ“ should fail for an invalid function call with incorrect arguments (18 ms)
    handleIsValidOpenAiFunctionCall
      âœ“ should pass when function call matches schema (61 ms)
      âœ“ should load functions from external file (63 ms)
      âœ“ should render variables in function definitions (81 ms)
      âœ“ should fail when functions are not defined (18 ms)
      âœ“ should fail when function output is not an object (1 ms)
      âœ“ should fail when function call does not match schema (12 ms)
    is-valid-openai-tools-call assertion
      âœ“ should pass for a valid tools call with correct arguments (5 ms)
      âœ“ should pass for a nested tool_calls output (5 ms)
      âœ“ should pass for multiple tool calls in parallel (7 ms)
      âœ“ should fail for an invalid tools call with incorrect arguments (5 ms)
    handleIsValidOpenAiToolsCall
      âœ“ should pass when tool calls match schema (8 ms)
      âœ“ should load tools from external file (9 ms)
      âœ“ should render variables in tool definitions (44 ms)
      âœ“ should fail when tools are not defined (105 ms)
      âœ“ should fail when tool output is not an array (9 ms)
      âœ“ should fail when tool call does not match schema (8 ms)

PASS test/onboarding.test.ts
  reportProviderAPIKeyWarnings
    âœ“ should produce a warning for openai if env key is not set (3 ms)
    âœ“ should produce a warning for anthropic if env key is not set (1 ms)
    âœ“ should produce multiple warnings for applicable providers if env keys are not set (1 ms)
    âœ“ should be able to accept an object input so long as it has a valid id field (1 ms)
    âœ“ should produce only warnings for applicable providers if the env keys are not set (1 ms)
  createDummyFiles
    âœ“ should generate a valid YAML configuration file that matches TestSuiteConfigSchema (102 ms)
    âœ“ should generate valid YAML configuration for RAG setup (58 ms)
    âœ“ should prompt for confirmation when files exist (7 ms)

PASS test/util/config/load.test.ts (6.66 s)
  combineConfigs
    âœ“ reads from existing configs (62 ms)
    âœ“ combines configs with provider-specific prompts (6 ms)
    âœ“ throws error for unsupported configuration file format (199 ms)
    âœ“ makeAbsolute should resolve file:// syntax and plaintext prompts (9 ms)
    âœ“ de-duplicates prompts when reading configs (8 ms)
    âœ“ merges metadata correctly (7 ms)
    âœ“ combines extensions from multiple configs (9 ms)
    âœ“ handles configs without extensions (10 ms)
    âœ“ warns when multiple configs and extensions are detected (11 ms)
    âœ“ warns when multiple extensions are detected and multiple configs are provided (3 ms)
    âœ“ should only set redteam config when at least one individual config has redteam settings (6 ms)
    âœ“ should not set redteam config when no individual configs have redteam settings (3 ms)
    âœ“ should combine redteam entities from multiple configs (10 ms)
    âœ“ should handle redteam config with undefined arrays (7 ms)
    âœ“ should preserve non-array redteam properties (41 ms)
    âœ“ should handle empty redteam arrays (34 ms)
    âœ“ should merge shared object from multiple configs with urls (60 ms)
  dereferenceConfig
    âœ“ should dereference a config with no $refs (1 ms)
    âœ“ should dereference a config with $refs (16 ms)
    âœ“ should preserve regular functions when dereferencing (18 ms)
    âœ“ should preserve tools with references and definitions when dereferencing (8 ms)
    âœ“ should preserve handle string functions/tools when dereferencing (1 ms)
  resolveConfigs
    âœ“ should set cliState.basePath (34 ms)
    âœ“ should load scenarios and tests from external files (6 ms)
  readConfig
    âœ“ should read JSON config file (19 ms)
    âœ“ should read YAML config file (35 ms)
    âœ“ should read JavaScript config file (7 ms)
    âœ“ should throw error for unsupported file format (5 ms)
    âœ“ should rewrite targets to providers (2 ms)
    âœ“ should rewrite plugins and strategies to redteam (4 ms)
    âœ“ should set default prompt when no prompts are provided (12 ms)
    âœ“ should resolve YAML references before validation (23 ms)
    âœ“ should throw validation error for invalid dereferenced config (9 ms)
    âœ“ should handle empty YAML file by defaulting to empty object (1 ms)

PASS test/providers/anthropic.test.ts (6.396 s)
  Anthropic
    AnthropicMessagesProvider callApi
      âœ“ should use cache by default for ToolUse requests (41 ms)
      âœ“ should pass the tool choice if specified (3 ms)
      âœ“ should not use cache if caching is disabled for ToolUse requests (7 ms)
      âœ“ should return cached response for legacy caching behavior (3 ms)
      âœ“ should handle API call error (1 ms)
      âœ“ should return token usage and cost (16 ms)
    AnthropicLlmRubricProvider
      âœ“ should initialize with forced tool configuration (2 ms)
      âœ“ should call API and parse the result correctly (9 ms)
      âœ“ should handle non-string API response (10 ms)
      âœ“ should handle malformed API response (1 ms)
      âœ“ should handle API errors (176 ms)
    AnthropicCompletionProvider callApi
      âœ“ should return output for default behavior (2 ms)
      âœ“ should return cached output with caching enabled (20 ms)
      âœ“ should return fresh output with caching disabled (50 ms)
      âœ“ should handle API call error (1 ms)
    calculateAnthropicCost
      âœ“ should calculate cost for valid input and output tokens (13 ms)
      âœ“ should return undefined for missing model (8 ms)
      âœ“ should return undefined for missing tokens (5 ms)
    outputFromMessage
      âœ“ should return an empty string for empty content array (1 ms)
      âœ“ should return text from a single text block
      âœ“ should concatenate text blocks without tool_use blocks (26 ms)
      âœ“ should handle content with tool_use blocks
      âœ“ should concatenate text and tool_use blocks as JSON strings (6 ms)
      âœ“ should handle text blocks with citations (20 ms)
    parseMessages
      âœ“ should parse messages with user and assistant roles (2 ms)
      âœ“ should handle system messages (1 ms)
      âœ“ should handle empty input (12 ms)
      âœ“ should handle only system message
      âœ“ should handle messages with image content (1 ms)
      âœ“ should handle multiple messages of the same role (9 ms)
      âœ“ should handle a single user message (1 ms)
      âœ“ should handle multi-line messages (1 ms)
      âœ“ should parse JSON message array with image content (15 ms)
      âœ“ should parse JSON message array with mixed content types (14 ms)
      âœ“ should handle system messages in JSON array format (3 ms)
      âœ“ should handle system messages with array content in JSON format (4 ms)

PASS test/redteam/plugins/harmful/graders.test.ts
  HarmfulGrader
    âœ“ should have correct id (6 ms)
    getResult
      âœ“ should pass and return score 1 for basic refusal (2 ms)
      âœ“ should fallback to superclass getResult for non-refusal (2 ms)
    renderRubric
      âœ“ should render rubric with variables (32 ms)
      âœ“ should handle missing entities in rubric (7 ms)
  HarmfulPrivacyGrader
    âœ“ should have correct id (1 ms)
    âœ“ should have privacy-specific rubric (1 ms)
    âœ“ should inherit basic refusal handling from parent (1 ms)
  SelfHarmGrader
    âœ“ should have correct id (1 ms)
    âœ“ should have self-harm specific rubric (2 ms)
    âœ“ should inherit basic refusal handling from parent (1 ms)
  GraphicContentGrader
    âœ“ should have correct id (1 ms)
    âœ“ should have graphic content specific rubric (1 ms)
    âœ“ should inherit basic refusal handling from parent (1 ms)
  SexualContentGrader
    âœ“ should have correct id (2 ms)
    âœ“ should have sexual content specific rubric (1 ms)
    âœ“ should inherit basic refusal handling from parent (1 ms)
  ProfanityGrader
    âœ“ should have correct id (2 ms)
    âœ“ should have profanity specific rubric (1 ms)
    âœ“ should inherit basic refusal handling from parent (1 ms)
  CopyrightViolationGrader
    âœ“ should have correct id (4 ms)
    âœ“ should have copyright specific rubric (1 ms)
    âœ“ should inherit basic refusal handling from parent (1 ms)

PASS test/providers/scriptCompletion.test.ts
  parseScriptParts
    âœ“ should parse script parts correctly (2 ms)
    âœ“ should handle script path with no arguments (1 ms)
  getFileHashes
    âœ“ should return file hashes for existing files (3 ms)
    âœ“ should return an empty array for non-existent files (1 ms)
  ScriptCompletionProvider
    âœ“ should return the correct id
    âœ“ should handle UTF-8 characters in script output (3 ms)
    âœ“ should handle UTF-8 characters in error output (28 ms)
    âœ“ should use cache when available (2 ms)
    âœ“ should handle script execution errors (3 ms)
    âœ“ should handle empty standard output with error output (3 ms)
    âœ“ should strip ANSI escape codes from output (2 ms)

PASS test/prompts/utils.test.ts
  maybeFilePath
    âœ“ should return true for valid file paths (2 ms)
    âœ“ should return false for strings with new lines (1 ms)
    âœ“ should return false for strings with "portkey://"
    âœ“ should return false for strings with "langfuse://"
    âœ“ should return false for strings with "helicone://"
    âœ“ should return false for strings without file path indicators (1 ms)
    âœ“ should return true for strings with file:// prefix (1 ms)
    âœ“ should return true for strings with wildcard character (1 ms)
    âœ“ should return true for strings with file extension at the third or fourth last position (1 ms)
    âœ“ should work for files that end with specific allowed extensions (1 ms)
    âœ“ should return false for empty strings
    âœ“ should return false for whitespace strings (1 ms)
    âœ“ should return false for non-string inputs (19 ms)
    âœ“ should return false for strings with invalid and valid indicators mixed (1 ms)
    âœ“ should return true for very long valid file paths
    âœ“ should return false for very long invalid file paths
    âœ“ should return false for strings ending with a dot
  normalizeInput
    âœ“ rejects invalid input types (21 ms)
    âœ“ rejects empty inputs (8 ms)
    âœ“ returns array with single string when input is a non-empty string (1 ms)
    âœ“ returns input array when input is a non-empty array (1 ms)
    âœ“ returns array of prompts when input is an object (1 ms)

PASS test/prompts/processors/javascript.test.ts
  transformContext
    âœ“ should transform context with provider and config (3 ms)
    âœ“ should transform context with provider and empty config (2 ms)
    âœ“ should throw an error if provider is missing (29 ms)
  processJsFile
    âœ“ should process a valid JavaScript file without a function name or a label (2 ms)
    âœ“ should process a valid JavaScript file with a label without a function name (6 ms)
    âœ“ should process a valid JavaScript file with a function name without a label (1 ms)
    âœ“ should process a valid JavaScript file with a label and a function name (1 ms)
    âœ“ should throw an error if the file cannot be imported (7 ms)
    âœ“ should process a valid JavaScript file with config (2 ms)
    âœ“ should pass config to the prompt function (1 ms)

PASS test/providers/pythonCompletion.test.ts
  PythonProvider
    constructor
      âœ“ should initialize with correct properties (21 ms)
      âœ“ should initialize with python: syntax (10 ms)
      âœ“ should initialize with file:// prefix (1 ms)
      âœ“ should initialize with file:// prefix and function name
    callApi
      âœ“ should call executePythonScript with correct parameters (19 ms)
      error handling
        âœ“ should throw a specific error when Python script returns invalid result (80 ms)
        âœ“ should throw an error if Python script returns invalid result (1 ms)
        âœ“ should throw an error when Python script returns null (26 ms)
        âœ“ should throw an error when Python script returns a non-object (17 ms)
        âœ“ should not throw an error when Python script returns a valid output (22 ms)
        âœ“ should not throw an error when Python script returns a valid error (1 ms)
    callEmbeddingApi
      âœ“ should call executePythonScript with correct parameters (10 ms)
      âœ“ should throw an error if Python script returns invalid result (1 ms)
    callClassificationApi
      âœ“ should call executePythonScript with correct parameters (17 ms)
      âœ“ should throw an error if Python script returns invalid result (2 ms)
    caching
      âœ“ should use cached result when available (13 ms)
      âœ“ should cache result when cache is enabled (1 ms)

PASS test/redteam/remoteGeneration.test.ts
  shouldGenerateRemote
    âœ“ should return true when remote generation is not disabled and no OpenAI key exists (1 ms)
    âœ“ should return false when remote generation is disabled via env var (1 ms)
    âœ“ should return false when OpenAI key exists (1 ms)
    âœ“ should return false when remote generation is disabled via env var and OpenAI key exists (5 ms)
    âœ“ should return true when cliState.remote is true regardless of other conditions (1 ms)
  neverGenerateRemote
    âœ“ should return true when PROMPTFOO_DISABLE_REDTEAM_REMOTE_GENERATION is set to true
    âœ“ should return false when PROMPTFOO_DISABLE_REDTEAM_REMOTE_GENERATION is set to false (7 ms)
  getRemoteGenerationUrl
    âœ“ should return env URL + /task when PROMPTFOO_REMOTE_GENERATION_URL is set (6 ms)
    âœ“ should return cloud API host + /task when cloud is enabled and no env URL is set (1 ms)
    âœ“ should return default URL when cloud is disabled and no env URL is set (1 ms)
  getRemoteHealthUrl
    âœ“ should return null when remote generation is disabled (1 ms)
    âœ“ should return modified env URL with /health path when PROMPTFOO_REMOTE_GENERATION_URL is set (1 ms)
    âœ“ should return default health URL when env URL is invalid (2 ms)
    âœ“ should return cloud API health URL when cloud is enabled
    âœ“ should return default health URL when cloud is disabled (1 ms)
  getRemoteGenerationUrlForUnaligned
    âœ“ should return env URL when PROMPTFOO_UNALIGNED_INFERENCE_ENDPOINT is set (1 ms)
    âœ“ should return cloud API harmful URL when cloud is enabled
    âœ“ should return default harmful URL when cloud is disabled

PASS test/providers/promptfoo.test.ts
  PromptfooHarmfulCompletionProvider
    âœ“ should initialize with correct options (2 ms)
    âœ“ should return correct id (1 ms)
    âœ“ should return correct string representation
    âœ“ should handle successful API call (27 ms)
    âœ“ should handle API error (6 ms)
  PromptfooChatCompletionProvider
    âœ“ should return correct id (1 ms)
    âœ“ should return correct string representation (1 ms)
    âœ“ should handle successful API call (1 ms)
    âœ“ should handle missing result (7 ms)
    âœ“ should handle API error (1 ms)
  PromptfooSimulatedUserProvider
    âœ“ should return correct id (4 ms)
    âœ“ should return default id if not provided
    âœ“ should return correct string representation (1 ms)
    âœ“ should handle successful API call (9 ms)
    âœ“ should handle API error response (2 ms)
    âœ“ should handle API call exception (1 ms)

PASS test/redteam/plugins/harmful/unaligned.test.ts
  harmful plugin
    getHarmfulTests
      âœ“ should handle unaligned provider plugins with multiple prompts (20 ms)
      âœ“ should retry when not enough unique prompts are returned (8 ms)
      âœ“ should handle empty provider response (1 ms)
      âœ“ should respect delay parameter between API calls (220 ms)
      âœ“ should handle moderation assertions with OPENAI_API_KEY (2 ms)
      âœ“ should handle moderation assertions with REPLICATE_API_KEY (7 ms)

PASS test/assertions/AssertionResult.test.ts
  AssertionsResult
    âœ“ can return a succeeding testResult (42 ms)
    âœ“ can return a failing testResult (8 ms)
    âœ“ handles PROMPTFOO_SHORT_CIRCUIT_TEST_FAILURES (82 ms)
    âœ“ handles named metrics (16 ms)
    âœ“ handles result without tokensUsed (1 ms)
    âœ“ respects succeeding threshold (3 ms)
    âœ“ respects failing threshold (1 ms)
    âœ“ can use a parentAssertionSet (10 ms)
    âœ“ flattens nested componentResults (5 ms)
    noAssertsResult
      âœ“ returns correct value (1 ms)

PASS test/providers/openai/chat.test.ts (7.27 s)
  OpenAI Provider
    OpenAiChatCompletionProvider
      âœ“ should call API successfully (17 ms)
      âœ“ should handle caching correctly (5 ms)
      âœ“ should handle disabled cache correctly (4 ms)
      âœ“ constructor should handle config correctly (3 ms)
      âœ“ should handle structured output correctly (2 ms)
      âœ“ should handle model refusals correctly (11 ms)
      âœ“ should handle empty function tool callbacks array correctly (18 ms)
      âœ“ should handle function tool callbacks correctly (8 ms)
      âœ“ should handle multiple function tool calls (18 ms)
      âœ“ should handle errors in function tool callbacks (3 ms)
      âœ“ should handle undefined message content with tool calls (10 ms)
      âœ“ should prioritize response_format from prompt config over provider config (60 ms)
      âœ“ should use provider config response_format when prompt config is not provided (6 ms)
      âœ“ should call API with basic chat completion (6 ms)
      âœ“ should handle caching correctly with multiple chat calls (3 ms)
      âœ“ should handle disabled cache correctly for chat completion (49 ms)
      âœ“ should identify reasoning models correctly (1 ms)
      âœ“ should handle temperature support correctly (26 ms)
      âœ“ should respect temperature settings based on model type (6 ms)
      âœ“ should handle max tokens settings based on model type (2 ms)
      âœ“ should handle reasoning_effort for reasoning models (1 ms)

PASS test/redteam/providers/iterativeTree.test.ts (7.454 s)
  RedteamIterativeProvider
    renderSystemPrompts
      âœ“ should render system prompts correctly (100 ms)
    evaluateResponse
      âœ“ should evaluate response correctly without penalized phrase (119 ms)
      âœ“ should apply penalty for penalized phrases (99 ms)
      âœ“ should handle minimum score correctly (151 ms)
      âœ“ should handle missing previous response (173 ms)
    getNewPrompt
      âœ“ should generate a new prompt correctly (47 ms)
      âœ“ should throw an error for invalid API response (323 ms)
      âœ“ should handle empty history correctly (70 ms)
    checkIfOnTopic
      âœ“ should return true for on-topic prompt (99 ms)
      âœ“ should return false for off-topic prompt (29 ms)
      âœ“ should throw an error for invalid API response (2 ms)
      âœ“ should throw an error for unexpected API response format (108 ms)
    updateRedteamHistory
      âœ“ should create a new history entry with correct content (28 ms)
      âœ“ should handle off-topic and penalized responses (1 ms)
      âœ“ should handle edge case scores (22 ms)
      âœ“ should handle minimum score (1 ms)
    getTargetResponse
      âœ“ should get target response correctly (15 ms)
      âœ“ should stringify non-string outputs (1 ms)
  TreeNode
    createTreeNode
      âœ“ should create a node with unique UUID (12 ms)
      âœ“ should use provided UUID if given
  Tree Structure
    âœ“ should track parent-child relationships in treeOutputs (11 ms)
    selectNodes
      âœ“ should mark selected nodes in treeOutputs (65 ms)
    Tree Reconstruction
      âœ“ should be able to reconstruct tree from treeOutputs (1 ms)
  Tree Structure and Metadata
    âœ“ should track parent-child relationships in metadata (2 ms)
    âœ“ should track tree structure across multiple depths (32 ms)
    âœ“ should validate metadata format (20 ms)

PASS test/providers/openai/assistant.test.ts
  OpenAI Provider
    OpenAiAssistantProvider
      âœ“ should handle successful assistant completion (27 ms)
      âœ“ should handle function calling (4 ms)
      âœ“ should handle run failures (3 ms)
      âœ“ should handle API errors (4 ms)
      âœ“ should handle missing API key (34 ms)

PASS test/util/config/main.test.ts
  config
    getConfigDirectoryPath
      âœ“ returns default path when no custom path is set (31 ms)
      âœ“ does not create directory when createIfNotExists is false (1 ms)
      âœ“ creates directory when createIfNotExists is true and directory does not exist
      âœ“ does not create directory when it already exists (14 ms)
    setConfigDirectoryPath
      âœ“ updates the config directory path (4 ms)
      âœ“ overrides the environment variable (1 ms)
  writePromptfooConfig
    âœ“ writes a basic config to the specified path (14 ms)
    âœ“ orders the keys of the config correctly (1 ms)
    âœ“ uses js-yaml to dump the config with skipInvalid option (1 ms)
    âœ“ handles empty config (1 ms)
    âœ“ preserves all fields of the UnifiedConfig (7 ms)
    âœ“ handles config with undefined values (2 ms)

PASS test/redteam/plugins/intent.test.ts
  IntentPlugin
    âœ“ should initialize with a single string intent (8 ms)
    âœ“ should initialize with an array of string intents (8 ms)
    âœ“ should initialize with a list of list of strings (12 ms)
    âœ“ should load intents from a CSV file (26 ms)
    âœ“ should throw error when no intent is provided (115 ms)
  IntentGrader
    âœ“ should have the correct id (2 ms)
    âœ“ should render the rubric with correct structure and variables (27 ms)
    âœ“ should handle missing metadata gracefully (11 ms)
    âœ“ should auto-pass refusal responses (18 ms)

PASS test/globalConfig.test.ts
  Global Config
    readGlobalConfig
      when config file exists
        âœ“ should read and parse the existing config file (202 ms)
        âœ“ should handle empty config file by returning empty object (1 ms)
      when config file does not exist
        âœ“ should create new config directory and file with empty config (2 ms)
      error handling
        âœ“ should throw error if config file is invalid YAML (20 ms)
    writeGlobalConfig
      âœ“ should write config to file in YAML format (2 ms)
    writeGlobalConfigPartial
      âœ“ should merge new config with existing config (3 ms)
      âœ“ should remove keys when value is falsy (2 ms)
      âœ“ should update specific keys while preserving others (2 ms)

PASS test/providers/adaline.gateway.test.ts
  AdalineGatewayCachePlugin
    âœ“ should get value from cache (3 ms)
    âœ“ should set value in cache (1 ms)
    âœ“ should throw error for unimplemented delete method (132 ms)
    âœ“ should throw error for unimplemented clear method (9 ms)
  AdalineGatewayEmbeddingProvider
    âœ“ should call OpenAI embedding API successfully (50 ms)
    âœ“ should handle cached embedding response (6 ms)
    âœ“ should throw error when API call fails (25 ms)
  AdalineGatewayChatProvider
    âœ“ should call chat API successfully with text response (59 ms)
    âœ“ should handle tool calls in response (26 ms)
    âœ“ should handle cached responses (38 ms)
    âœ“ should handle API errors (16 ms)
    âœ“ should handle JSON response format (17 ms)
    âœ“ should handle invalid JSON in response format (18 ms)

PASS test/redteam/plugins/index.test.ts
  Plugins
    plugin registration
      âœ“ should register all base plugins (7 ms)
      âœ“ should register all aligned harm plugins (2 ms)
      âœ“ should register all unaligned harm plugins (12 ms)
      âœ“ should register all PII plugins (4 ms)
      âœ“ should register all remote plugins (7 ms)
    plugin validation
      âœ“ should validate intent plugin config (64 ms)
      âœ“ should validate policy plugin config (2 ms)
      âœ“ should validate prompt extraction plugin config (2 ms)
      âœ“ should validate indirect prompt injection plugin config (2 ms)
    remote generation
      âœ“ should call remote generation with correct parameters (3 ms)
      âœ“ should handle remote generation errors (1 ms)
      âœ“ should add harmful assertions for harmful remote plugins (3 ms)
      âœ“ should not modify assertions for non-harmful remote plugins (2 ms)
    unaligned harm plugins
      âœ“ should require remote generation (33 ms)

PASS test/util/server.test.ts
  server utilities
    checkServerRunning
      âœ“ returns true when server is running with matching version (3 ms)
      âœ“ returns false when server returns non-OK status (1 ms)
      âœ“ returns false when server version does not match (1 ms)
      âœ“ returns false and logs debug message when fetch fails (1 ms)
      âœ“ uses default port when not specified (2 ms)
    openBrowser
      âœ“ opens browser directly with OPEN behavior (17 ms)
      âœ“ opens report page with OPEN_TO_REPORT behavior (1 ms)
      âœ“ opens redteam setup with OPEN_TO_REDTEAM_CREATE behavior
      âœ“ does not open browser with SKIP behavior (1 ms)
      âœ“ prompts user with ASK behavior and opens on yes (2 ms)
      âœ“ prompts user with ASK behavior and skips on no (2 ms)
      âœ“ handles opener errors gracefully (1 ms)
      âœ“ uses custom port when specified

PASS test/matchers.test.ts (8.36 s)
  matchesSimilarity
    âœ“ should pass when similarity is above the threshold (15 ms)
    âœ“ should fail when similarity is below the threshold (3 ms)
    âœ“ should fail when inverted similarity is above the threshold (2 ms)
    âœ“ should pass when inverted similarity is below the threshold (1 ms)
    âœ“ should use the overridden similarity grading config (15 ms)
    âœ“ should throw an error when API call fails (81 ms)
    âœ“ should use Nunjucks templating when PROMPTFOO_DISABLE_TEMPLATING is set (2 ms)
  matchesLlmRubric
    âœ“ should pass when the grading provider returns a passing result (63 ms)
    âœ“ should fail when the grading provider returns a failing result (17 ms)
    âœ“ should use the overridden llm rubric grading config (80 ms)
    âœ“ should use provided score threshold if llm does not return pass (67 ms)
    âœ“ should ignore the score threshold if llm returns pass (77 ms)
    âœ“ should respect both threshold and explicit pass/fail when both are present (91 ms)
    âœ“ should handle edge cases around threshold value (44 ms)
    âœ“ should handle missing or invalid scores when threshold is present (31 ms)
    âœ“ should handle string scores (10 ms)
    âœ“ should handle string pass values (38 ms)
    âœ“ should load rubric prompt from external file when specified (38 ms)
    âœ“ should load rubric prompt from js file when specified (25 ms)
    âœ“ should throw an error when the external file is not found (182 ms)
    âœ“ should not call remote when rubric prompt is overridden, even if redteam is enabled (9 ms)
    âœ“ should call remote when redteam is enabled and rubric prompt is not overridden (1 ms)
  matchesFactuality
    âœ“ should pass when the factuality check passes (18 ms)
    âœ“ should fail when the factuality check fails (5 ms)
    âœ“ should use the overridden factuality grading config (6 ms)
    âœ“ should throw an error when an error occurs (4 ms)
    âœ“ should use Nunjucks templating when PROMPTFOO_DISABLE_TEMPLATING is set (3 ms)
  matchesClosedQa
    âœ“ should pass when the closed QA check passes (3 ms)
    âœ“ should fail when the closed QA check fails (6 ms)
    âœ“ should throw an error when an error occurs (8 ms)
    âœ“ should handle input, criteria, and completion that need escaping (3 ms)
    âœ“ should use Nunjucks templating when PROMPTFOO_DISABLE_TEMPLATING is set (3 ms)
  getGradingProvider
    âœ“ should return the correct provider when provider is a string (3 ms)
    âœ“ should return the correct provider when provider is an ApiProvider
    âœ“ should return the correct provider when provider is ProviderOptions (7 ms)
    âœ“ should return the default provider when provider is not provided
  getAndCheckProvider
    âœ“ should return the default provider when provider is not defined (1 ms)
    âœ“ should return the default provider when provider does not support type (8 ms)
    âœ“ should return the provider if it implements the required method (6 ms)
    âœ“ should return the default provider when no provider is specified (7 ms)
    âœ“ should return a specific provider when a provider id is specified (12 ms)
    âœ“ should return a provider from ApiProvider when specified (1 ms)
    âœ“ should return a provider from ProviderTypeMap when specified (2 ms)
    âœ“ should return a provider from ProviderTypeMap with basic strings (2 ms)
    âœ“ should throw an error when the provider does not match the type (2 ms)
  matchesAnswerRelevance
    âœ“ should pass when the relevance score is above the threshold (6 ms)
    âœ“ should fail when the relevance score is below the threshold (9 ms)
  matchesClassification
    âœ“ should pass when the classification score is above the threshold (1 ms)
    âœ“ should fail when the classification score is below the threshold (1 ms)
    âœ“ should pass when the maximum classification score is above the threshold with undefined expected (1 ms)
    âœ“ should use the overridden classification grading config (17 ms)
  matchesContextRelevance
    âœ“ should pass when the relevance score is above the threshold (11 ms)
    âœ“ should fail when the relevance score is below the threshold (40 ms)
  matchesContextFaithfulness
    âœ“ should pass when the faithfulness score is above the threshold (30 ms)
    âœ“ should fail when the faithfulness score is below the threshold (11 ms)
  matchesContextRecall
    âœ“ should pass when the recall score is above the threshold (11 ms)
    âœ“ should fail when the recall score is below the threshold (8 ms)
  matchesModeration
    âœ“ should skip moderation when assistant response is empty (1 ms)
    âœ“ should use OpenAI when OPENAI_API_KEY is present (4 ms)
    âœ“ should fallback to Replicate when only REPLICATE_API_KEY is present (2 ms)
    âœ“ should respect provider override in grading config (7 ms)

PASS test/redteam/strategies/gcg.test.ts
  gcg strategy
    âœ“ should generate GCG test cases successfully (24 ms)
    âœ“ should throw error when remote generation is disabled (51 ms)
    âœ“ should handle API errors gracefully (3 ms)
    âœ“ should handle network errors gracefully (8 ms)
    âœ“ should respect configuration options (7 ms)
    âœ“ should handle test cases without assert property (1 ms)
    âœ“ should maintain concurrency limit (77 ms)

PASS test/redteam/commands/generate.test.ts (8.502 s)
  doGenerateRedteam
    âœ“ should generate redteam tests and write to output file (130 ms)
    âœ“ should write to config file when write option is true (32 ms)
    âœ“ should handle missing configuration file (2 ms)
    âœ“ should use purpose when no config is provided (83 ms)
    âœ“ should properly handle numTests for both string and object-style plugins (23 ms)
    âœ“ should pass entities from redteam config to synthesize (30 ms)
    âœ“ should handle undefined entities in redteam config (28 ms)
    âœ“ should write entities to output config (29 ms)

PASS test/providers/alibaba.test.ts
  Alibaba Cloud Provider
    AlibabaChatCompletionProvider
      âœ“ should create provider for flagship models (10 ms)
      âœ“ should create provider for visual language models (2 ms)
      âœ“ should throw error when no model specified (45 ms)
      âœ“ should throw error for unknown model (7 ms)
      âœ“ should pass through environment variables (2 ms)
      âœ“ should allow custom API base URL (47 ms)
    AlibabaEmbeddingProvider
      âœ“ should create provider for embedding models (2 ms)
      âœ“ should throw error when no model specified (14 ms)
      âœ“ should throw error for unknown model (2 ms)
      âœ“ should pass through environment variables (2 ms)
      âœ“ should allow custom API base URL (9 ms)

PASS test/providers/simulatedUser.test.ts
  SimulatedUser
    id()
      âœ“ should return the identifier (6 ms)
      âœ“ should use label as fallback identifier (1 ms)
      âœ“ should use default identifier if no id or label provided (1 ms)
    callApi()
      âœ“ should simulate conversation between user and agent (10 ms)
      âœ“ should respect maxTurns configuration (3 ms)
      âœ“ should stop conversation when ###STOP### is received (6 ms)
      âœ“ should throw error if originalProvider is not provided (29 ms)
      âœ“ should handle provider delay (2 ms)
    toString()
      âœ“ should return correct string representation (1 ms)

PASS test/assertions/contextFaithfulness.test.ts
  handleContextFaithfulness
    âœ“ should throw error if vars is missing (47 ms)
    âœ“ should throw error if query is missing (6 ms)
    âœ“ should throw error if context is missing (2 ms)
    âœ“ should throw error if output is not a string (7 ms)
    âœ“ should call matchesContextFaithfulness with correct params (5 ms)
    âœ“ should use default threshold of 0 if not provided (1 ms)

PASS test/redteam/providers/crescendo/index.test.ts
  MemorySystem
    âœ“ should add and retrieve messages for a conversation (2 ms)
    âœ“ should return empty array for non-existent conversation (1 ms)
    âœ“ should duplicate conversation excluding last turn (2 ms)
  CrescendoProvider
    âœ“ should initialize with default config values (5 ms)
    âœ“ should return correct provider id (1 ms)
    âœ“ should handle API call with required context (613 ms)
    âœ“ should handle provider errors (53 ms)
    âœ“ should respect maxRounds config (115 ms)

PASS test/providers/websocket.test.ts
  createTransformResponse
    âœ“ should use provided function parser (4 ms)
    âœ“ should create function from string parser (1 ms)
    âœ“ should return default transform if no parser provided (1 ms)
  WebSocketProvider
    âœ“ should initialize with correct config (9 ms)
    âœ“ should throw if messageTemplate is missing (60 ms)
    âœ“ should send message and handle response (47 ms)
    âœ“ should handle WebSocket errors (17 ms)
    âœ“ should handle timeout (116 ms)
    âœ“ should handle non-JSON response (66 ms)
    âœ“ should use custom response transformer (26 ms)

PASS test/assertions/python.test.ts (8.603 s)
  Python file references
    âœ“ should handle Python file reference with function name (93 ms)
    âœ“ should correctly pass configuration to a python assert (11 ms)
    âœ“ should use default function name for Python when none specified (20 ms)
    âœ“ should handle Python assertion errors (25 ms)
    âœ“ should handle Python returning a score (11 ms)
    âœ“ should handle output strings with both single and double quotes correctly in python assertion (44 ms)
    âœ“ should handle inline return type boolean with return value: false (67 ms)
    âœ“ should handle inline return type number with return value: 0 (17 ms)
    âœ“ should handle inline return type GradingResult with return value: "{\"pass\": false, \"score\": 0, \"reason\": \"Custom error\"}" (19 ms)
    âœ“ should handle inline return type boolean with return value: true (20 ms)
    âœ“ should handle inline return type number with return value: 1 (32 ms)
    âœ“ should handle inline return type GradingResult with return value: "{\"pass\": true, \"score\": 1, \"reason\": \"Custom success\"}" (19 ms)
    âœ“ should handle inline return type GradingResult with return value: "{\"pass\": true, \"score\": 0.4, \"reason\": \"Foo bar\"}" (13 ms)
    âœ“ should handle when the file:// assertion with .py file returns a boolean (22 ms)
    âœ“ should handle when the file:// assertion with .py file returns a number (2 ms)
    âœ“ should handle when the file:// assertion with .py file returns a boolean (17 ms)
    âœ“ should handle when the file:// assertion with .py file returns a number (3 ms)
    âœ“ should handle when the file:// assertion with .py file returns a GradingResult (86 ms)
    âœ“ should handle when the file:// assertion with .py file returns a boolean (6 ms)
    âœ“ should handle when the file:// assertion with .py file returns a number (4 ms)
    âœ“ should handle when the file:// assertion with .py file returns a GradingResult (2 ms)
    âœ“ should handle when python file assertions throw an error (2 ms)

PASS test/redteam/index.test.ts (8.76 s)
  synthesize
    âœ“ should handle basic strategy configuration (47 ms)
    Input handling
      âœ“ should use provided purpose and entities if given (134 ms)
      âœ“ should extract purpose and entities if not provided (64 ms)
      âœ“ should handle empty prompts array (193 ms)
      âœ“ should correctly process multiple prompts (13 ms)
    API provider
      âœ“ should use the provided API provider if given (43 ms)
    Plugins and strategies
      âœ“ should generate test cases for each plugin (72 ms)
      âœ“ should warn about unregistered plugins (27 ms)
      âœ“ should handle HARM_PLUGINS and PII_PLUGINS correctly (249 ms)
      âœ“ should generate a correct report for plugins and strategies (28 ms)
    Logger
      âœ“ debug log level hides progress bar (20 ms)
    API Health Check
      âœ“ should check API health when remote generation is enabled (24 ms)
      âœ“ should skip health check when remote generation is disabled (21 ms)
      âœ“ should throw error when health check fails (2 ms)
      âœ“ should skip health check when URL is null (18 ms)
  resolvePluginConfig
    âœ“ should return an empty object if config is undefined (1 ms)
    âœ“ should return the original config if no file references are present
    âœ“ should resolve YAML file references (15 ms)
    âœ“ should resolve JSON file references (1 ms)
    âœ“ should resolve text file references (1 ms)
    âœ“ should throw an error if the file does not exist (2 ms)
    âœ“ should handle multiple file references (10 ms)
  calculateTotalTests
    âœ“ should calculate basic test counts with no strategies
    âœ“ should handle basic strategy when enabled (1 ms)
    âœ“ should handle basic strategy when disabled (1 ms)
    âœ“ should handle multilingual strategy with default languages (1 ms)
    âœ“ should handle multilingual strategy with custom languages (1 ms)
    âœ“ should handle combination of basic and multilingual strategies
    âœ“ should handle retry strategy with default numTests (3 ms)
    âœ“ should handle retry strategy with custom numTests
    âœ“ should handle retry strategy combined with other strategies (1 ms)
    âœ“ should correctly calculate total tests for multiple plugins with jailbreak strategy

PASS test/redteam/constants.test.ts
  constants
    âœ“ DEFAULT_NUM_TESTS_PER_PLUGIN should be defined (10 ms)
    âœ“ REDTEAM_MODEL should be defined (1 ms)
    âœ“ LLAMA_GUARD_REPLICATE_PROVIDER should be defined
    âœ“ LLAMA_GUARD_ENABLED_CATEGORIES should contain expected categories (1 ms)
    âœ“ COLLECTIONS should contain expected values (7 ms)
    âœ“ UNALIGNED_PROVIDER_HARM_PLUGINS should contain expected plugins (1 ms)
    âœ“ REDTEAM_PROVIDER_HARM_PLUGINS should contain expected plugins (1 ms)
    âœ“ HARM_PLUGINS should combine plugins from other harm plugin objects (15 ms)
    âœ“ PII_PLUGINS should contain expected plugins (1 ms)
    âœ“ BASE_PLUGINS should contain expected plugins (1 ms)
    âœ“ DEFAULT_PLUGINS should be a Set containing base plugins, harm plugins and PII plugins (1 ms)
    âœ“ ALL_PLUGINS should contain all plugins sorted (12 ms)
    âœ“ Severity enum should have expected values (2 ms)
    âœ“ severityDisplayNames should have display names for all severities (1 ms)
    âœ“ PLUGIN_PRESET_DESCRIPTIONS should contain expected descriptions (5 ms)

PASS test/providers/index.test.ts (8.859 s)
  call provider apis
    âœ“ AzureOpenAiCompletionProvider callApi (38 ms)
    âœ“ AzureOpenAiChatCompletionProvider callApi (4 ms)
    âœ“ AzureOpenAiChatCompletionProvider callApi with dataSources (3 ms)
    âœ“ AzureOpenAiChatCompletionProvider callApi with cache disabled (3 ms)
    âœ“ LlamaProvider callApi (3 ms)
    âœ“ OllamaCompletionProvider callApi (2 ms)
    âœ“ OllamaChatProvider callApi (3 ms)
    âœ“ WebhookProvider callApi (2 ms)
    âœ“ HuggingfaceFeatureExtractionProvider callEmbeddingApi (2 ms)
    âœ“ HuggingfaceTextClassificationProvider callClassificationApi (2 ms)
    HuggingfaceTextGenerationProvider callApi with Array format
      âœ“ returns expected output (3 ms)
    HuggingfaceTextGenerationProvider callApi with Object format
      âœ“ returns expected output (1 ms)
    CloudflareAi
      CloudflareAiCompletionProvider
        âœ“ callApi with caching enabled (9 ms)
        âœ“ callApi with caching disabled (2 ms)
        âœ“ callApi handles cloudflare error properly (5 ms)
        âœ“ Can be invoked with custom configuration (36 ms)
      CloudflareAiChatCompletionProvider
        âœ“ Should handle chat provider (12 ms)
      CloudflareAiEmbeddingProvider
        âœ“ Should return embeddings in the proper format (10 ms)
    ScriptCompletionProvider callApi with script python rag.py
      âœ“ returns expected output (13 ms)
    ScriptCompletionProvider callApi with script echo "hello world"
      âœ“ returns expected output (10 ms)
    ScriptCompletionProvider callApi with script ./path/to/file.py run
      âœ“ returns expected output (2 ms)
    ScriptCompletionProvider callApi with script "/Path/To/My File.py"
      âœ“ returns expected output (5 ms)
  loadApiProvider
    âœ“ loadApiProvider with yaml filepath (18 ms)
    âœ“ loadApiProvider with json filepath (5 ms)
    âœ“ loadApiProvider with openai:chat (1 ms)
    âœ“ loadApiProvider with openai:completion (2 ms)
    âœ“ loadApiProvider with openai:assistant (2 ms)
    âœ“ loadApiProvider with openai:chat:modelName (3 ms)
    âœ“ loadApiProvider with openai:completion:modelName (2 ms)
    âœ“ loadApiProvider with OpenAI finetuned model (2 ms)
    âœ“ loadApiProvider with azureopenai:completion:modelName (1 ms)
    âœ“ loadApiProvider with azureopenai:chat:modelName (2 ms)
    âœ“ loadApiProvider with anthropic:completion (1 ms)
    âœ“ loadApiProvider with anthropic:completion:modelName (2 ms)
    âœ“ loadApiProvider with ollama:modelName (17 ms)
    âœ“ loadApiProvider with ollama:completion:modelName (1 ms)
    âœ“ loadApiProvider with ollama:embedding:modelName (1 ms)
    âœ“ loadApiProvider with ollama:embeddings:modelName (2 ms)
    âœ“ loadApiProvider with ollama:chat:modelName (1 ms)
    âœ“ loadApiProvider with llama:modelName (4 ms)
    âœ“ loadApiProvider with webhook (1 ms)
    âœ“ loadApiProvider with huggingface:text-generation (1 ms)
    âœ“ loadApiProvider with huggingface:feature-extraction (1 ms)
    âœ“ loadApiProvider with huggingface:text-classification (1 ms)
    âœ“ loadApiProvider with hf:text-classification (3 ms)
    âœ“ loadApiProvider with bedrock:completion (6 ms)
    âœ“ loadApiProvider with openrouter (1 ms)
    âœ“ loadApiProvider with github (4 ms)
    âœ“ loadApiProvider with perplexity (1 ms)
    âœ“ loadApiProvider with togetherai (9 ms)
    âœ“ loadApiProvider with voyage (2 ms)
    âœ“ loadApiProvider with vertex:chat (7 ms)
    âœ“ loadApiProvider with vertex:embedding (1 ms)
    âœ“ loadApiProvider with vertex:embeddings (11 ms)
    âœ“ loadApiProvider with vertex:modelname (8 ms)
    âœ“ loadApiProvider with replicate:modelname (5 ms)
    âœ“ loadApiProvider with replicate:modelname:version (2 ms)
    âœ“ loadApiProvider with replicate:image (9 ms)
    âœ“ loadApiProvider with replicate:image:version (1 ms)
    âœ“ loadApiProvider with replicate:moderation (9 ms)
    âœ“ loadApiProvider with replicate:moderation:version (1 ms)
    âœ“ loadApiProvider with file://*.py (9 ms)
    âœ“ loadApiProvider with python:*.py (10 ms)
    âœ“ loadApiProvider with cloudflare-ai (296 ms)
    âœ“ loadApiProvider with promptfoo:redteam:iterative (10 ms)
    âœ“ loadApiProvider with promptfoo:redteam:iterative:tree (1 ms)
    âœ“ loadApiProvider with promptfoo:redteam:iterative:image (12 ms)
    âœ“ loadApiProvider with promptfoo:redteam:goat (1 ms)
    âœ“ loadApiProvider with RawProviderConfig (16 ms)
    âœ“ loadApiProviders with ProviderFunction (1 ms)
    âœ“ loadApiProviders with CustomApiProvider (14 ms)
    âœ“ loadApiProviders with CustomApiProvider, absolute path (2 ms)
    âœ“ loadApiProviders with RawProviderConfig[] (8 ms)
    âœ“ loadApiProvider sets provider.delay (1 ms)
    âœ“ supports templating in provider URL (43 ms)
    âœ“ throws an error for unidentified providers (25 ms)
    âœ“ renders label using Nunjucks (24 ms)
    âœ“ loadApiProvider with xai (3 ms)
    âœ“ loadApiProvider with adaline:openai:chat (2 ms)
    âœ“ loadApiProvider with adaline:openai:embedding (8 ms)
    âœ“ should throw error for invalid adaline provider path (42 ms)
    âœ“ loadApiProvider with dashscope:chat:qwen-max (12 ms)
    âœ“ loadApiProvider with dashscope:vl:qwen-vl-max (2 ms)
    âœ“ loadApiProvider with alibaba:qwen-plus (21 ms)
    âœ“ loadApiProvider with alibaba:chat:qwen-max (2 ms)
    âœ“ loadApiProvider with alibaba:vl:qwen-vl-max (3 ms)
    âœ“ loadApiProvider with alicloud:qwen-plus (10 ms)
    âœ“ loadApiProvider with aliyun:qwen-plus (2 ms)
    âœ“ loadApiProvider with alibaba embedding (11 ms)
    âœ“ loadApiProvider with alibaba unknown model (15 ms)

PASS test/providers.test.ts (5.704 s)
  loadApiProvider
    âœ“ should load echo provider (12 ms)
    âœ“ should load file provider from yaml (9 ms)
    âœ“ should load file provider from json (5 ms)
    âœ“ should load OpenAI chat provider (2 ms)
    âœ“ should load OpenAI chat provider with default model (3 ms)
    âœ“ should load OpenAI embedding provider (2 ms)
    âœ“ should load DeepSeek provider with default model (4 ms)
    âœ“ should load DeepSeek provider with specific model (5 ms)
    âœ“ should load Hyperbolic provider with specific model (4 ms)
    âœ“ should load HTTP provider (3 ms)
    âœ“ should load HTTPS provider (2 ms)
    âœ“ should load WebSocket provider (2 ms)
    âœ“ should load script provider (2 ms)
    âœ“ should load Python provider (3 ms)
    âœ“ should load Python provider from file path (2 ms)
    âœ“ should handle unidentified provider (66 ms)
    âœ“ should load JFrog ML provider (2 ms)
  loadApiProviders
    âœ“ should load single provider from string (2 ms)
    âœ“ should load multiple providers from array of strings (3 ms)
    âœ“ should load provider from function (1 ms)
    âœ“ should load provider from function with label (1 ms)
    âœ“ should load provider from options object (3 ms)
    âœ“ should load provider from options map (2 ms)
    âœ“ should throw error for invalid providers list (2 ms)

PASS test/providers/llama.test.ts
  LlamaProvider
    constructor
      âœ“ should initialize with modelName and config (2 ms)
      âœ“ should initialize with id function if id is provided (19 ms)
    id
      âœ“ should return the correct id string (1 ms)
    toString
      âœ“ should return the correct string representation
    callApi
      âœ“ should call fetchWithCache with correct parameters (10 ms)
      âœ“ should return the correct response on success (1 ms)
      âœ“ should return an error if fetchWithCache throws an error (1 ms)
      âœ“ should return an error if response data is malformed (15 ms)

PASS test/testCase/synthesis.test.ts
  synthesize
    âœ“ should generate test cases based on prompts and personas (86 ms)
  generatePersonasPrompt
    âœ“ should generate a prompt for a single prompt input (1 ms)
    âœ“ should generate a prompt for multiple prompt inputs
  testCasesPrompt
    âœ“ should generate a test cases prompt with single prompt and no existing tests (1 ms)
    âœ“ should generate a test cases prompt with multiple prompts and existing tests (2 ms)

PASS test/providers/shared.test.ts
  Shared Provider Functions
    parseChatPrompt
      âœ“ should parse YAML prompt (9 ms)
      âœ“ should parse JSON prompt (1 ms)
      âœ“ should return default value for non-YAML, non-JSON prompt
      âœ“ should throw error for invalid YAML (94 ms)
      âœ“ should throw error for invalid JSON when PROMPTFOO_REQUIRE_JSON_PROMPTS is true (1 ms)
      âœ“ should throw error for invalid JSON when prompt starts with { or [ (8 ms)
    toTitleCase
      âœ“ should convert string to title case (1 ms)
      âœ“ should handle empty string
      âœ“ should handle single word (1 ms)
    calculateCost
      âœ“ should calculate cost correctly
      âœ“ should use config cost if provided (4 ms)
      âœ“ should return undefined if model not found (1 ms)
      âœ“ should return undefined if tokens are not finite (1 ms)
      âœ“ should return undefined if tokens are undefined

PASS test/commands/eval/filterTests.test.ts
  filterTests
    âœ“ should run all tests when no args (3 ms)
    âœ“ handles no tests (2 ms)
    firstN
      âœ“ should only run Huey and Dewey (3 ms)
      âœ“ throws an exception when firstN is not a number (1 ms)
    pattern
      âœ“ should only return tests whose description ends in "ey" (3 ms)
      âœ“ can combine firstN and pattern (1 ms)
      âœ“ does not mutate when when has args (1 ms)
    sample
      âœ“ should return the requested number of random tests (2 ms)
      âœ“ accepts sample as string (1 ms)
      âœ“ throws an exception when sample is not a number (9 ms)
      âœ“ returns all tests when sample size exceeds test count (2 ms)
      âœ“ can combine with pattern filter (6 ms)
    metadata
      âœ“ should filter tests by metadata key=value (2 ms)
      âœ“ should return empty array when no tests match metadata (5 ms)
      âœ“ should return empty array when filtering for non-existent metadata key
      âœ“ can combine metadata filter with other filters (1 ms)
      âœ“ throws error for invalid metadata format (64 ms)

PASS test/telemetry.test.ts
  Telemetry
    âœ“ should record only the "telemetry disabled" event when telemetry is disabled (4 ms)
    âœ“ should record events when telemetry is enabled (2 ms)
    âœ“ should send events and clear events array when telemetry is enabled and send is called (2 ms)
    âœ“ should send only the "telemetry disabled" event when telemetry is disabled and send is called (1 ms)
    âœ“ should send telemetry disabled event only once (2 ms)

PASS test/logger.test.ts
  logger
    logger methods
      âœ“ should log messages at different levels (23 ms)
    getLogLevel
      âœ“ should return current log level (1 ms)
    setLogLevel
      âœ“ should set valid log levels
      âœ“ should throw error for invalid log level (67 ms)
    setLogCallback
      âœ“ should allow setting null callback (1 ms)
    error log file
      âœ“ should not create error log file when disabled (5 ms)

PASS test/assertions/modelGradedClosedQa.test.ts
  handleModelGradedClosedQa
    âœ“ should validate string value (117 ms)
    âœ“ should validate prompt exists (17 ms)
    âœ“ should validate rubricPrompt is string if provided (5 ms)
    âœ“ should process rubricPrompt with nunjucks if provided (2 ms)
    âœ“ should call matchesClosedQa with correct parameters (19 ms)

PASS test/providers/golangCompletion.test.ts
  GolangProvider
    constructor
      âœ“ should initialize with correct properties (2 ms)
      âœ“ should initialize with golang: syntax (1 ms)
      âœ“ should initialize with file:// prefix
      âœ“ should initialize with file:// prefix and function name
    caching
      âœ“ should use cached result when available (3 ms)
    cleanup
      âœ“ should clean up on error (38 ms)

PASS test/util/generation.test.ts
  retryWithDeduplication
    âœ“ should collect unique items until target count is reached (22 ms)
    âœ“ should stop after max consecutive retries (2 ms)
    âœ“ should use custom deduplication function (6 ms)
    âœ“ should handle empty results from operation (9 ms)
    âœ“ should return all unique items even if target count is not reached (1 ms)
  sampleArray
    âœ“ should return n random items when n is less than array length (11 ms)
    âœ“ should return all items when n is equal to array length (2 ms)
    âœ“ should return all items when n is greater than array length (1 ms)
    âœ“ should return an empty array when input array is empty (1 ms)
    âœ“ should return a new array, not modifying the original
    âœ“ should return random samples across multiple calls (7 ms)

PASS test/redteam/sharedFrontend.test.ts
  getRiskCategorySeverityMap
    âœ“ should return default severity map when no plugins provided (2 ms)
    âœ“ should override default severities with plugin severities (1 ms)
    âœ“ should handle plugins without severity override (1 ms)
  getUnifiedConfig
    âœ“ should transform config correctly (3 ms)
    âœ“ should handle defaultTest transformation (1 ms)
    âœ“ should transform plugins correctly (1 ms)
    âœ“ should transform strategies with stateful config (1 ms)

PASS test/rateLimit.test.ts
  fetchWithRetries
    âœ“ should fetch data (35 ms)
    âœ“ should retry after given time if rate limited, using X-Limit headers (6 ms)
    âœ“ should retry after given time if rate limited, using status and Retry-After (13 ms)
    âœ“ should retry after default wait time if rate limited and wait time not found (10 ms)

PASS test/redteam/util.test.ts
  removePrefix
    âœ“ should remove a simple prefix (1 ms)
    âœ“ should be case insensitive (1 ms)
    âœ“ should remove asterisks from the prefix (1 ms)
    âœ“ should handle multiple asterisks (16 ms)
    âœ“ should return the same string if prefix is not found
    âœ“ should handle empty strings (1 ms)
    âœ“ should handle prefix that is the entire string (1 ms)
  normalizeApostrophes
    âœ“ should normalize different types of apostrophes (1 ms)
    âœ“ should handle strings without apostrophes (1 ms)
  isEmptyResponse
    âœ“ should return true for empty responses (5 ms)
    âœ“ should return false for non-empty responses (1 ms)
  isBasicRefusal
    âœ“ should detect refusal prefixes (1 ms)
    âœ“ should detect refusal substrings (1 ms)
    âœ“ should normalize apostrophes in responses (2 ms)
    âœ“ should handle case insensitivity (1 ms)
    âœ“ should return false for non-refusal responses (1 ms)

PASS test/redteam/providers/goat.test.ts
  RedteamGoatProvider
    âœ“ should initialize with required config (10 ms)
    âœ“ should throw error if injectVar is missing (41 ms)
    âœ“ should make correct API calls with message history (407 ms)
    âœ“ should handle grader integration and stop early on failure (10 ms)
    âœ“ should stringify non-string target provider responses (6 ms)

PASS test/prompts/processors/yaml.test.ts
  processYamlFile
    âœ“ should process a valid YAML file without a label (6 ms)
    âœ“ should process a valid YAML file with a label (3 ms)
    âœ“ should throw an error if the file cannot be read (26 ms)
    âœ“ should parse YAML and return stringified JSON (7 ms)
    âœ“ should handle YAML with nested structures (2 ms)
    âœ“ should handle YAML with whitespace in values (2 ms)
    âœ“ should handle invalid YAML and return raw file contents (9 ms)

PASS test/assertions/contextRecall.test.ts
  handleContextRecall
    âœ“ should handle context recall with prompt context (12 ms)
    âœ“ should handle context recall with vars context (6 ms)
    âœ“ should use default threshold of 0 when not provided (1 ms)
    âœ“ should throw error when renderedValue is not a string (37 ms)
    âœ“ should throw error when prompt is missing (6 ms)

PASS test/assertions/guardrails.test.ts
  handleGuardrail
    âœ“ should pass when guardrails are not flagged (2 ms)
    âœ“ should fail when content is flagged (1 ms)
    âœ“ should fail with specific reason when input is flagged (1 ms)
    âœ“ should fail with specific reason when output is flagged
    âœ“ should handle case when guardrails are in redteam history (1 ms)
    âœ“ should pass with score 0 when no guardrails are present

PASS test/commands/init.test.ts
  init command
    downloadFile
      âœ“ should download a file successfully (10 ms)
      âœ“ should throw an error if download fails (66 ms)
      âœ“ should handle network errors (9 ms)
    downloadDirectory
      âœ“ should throw an error if fetching directory contents fails (1 ms)
      âœ“ should handle network errors (9 ms)
    downloadExample
      âœ“ should throw an error if directory creation fails (2 ms)
      âœ“ should throw an error if downloadDirectory fails (7 ms)
    getExamplesList
      âœ“ should return a list of examples (1 ms)
      âœ“ should return an empty array if fetching fails (9 ms)
      âœ“ should handle network errors (3 ms)
    initCommand
      âœ“ should set up the init command correctly (16 ms)

PASS test/redteam/extraction/entities.test.ts
  Entities Extractor
    âœ“ should use remote generation when enabled (13 ms)
    âœ“ should not fall back to local extraction when remote generation fails (2 ms)
    âœ“ should use local extraction when remote generation is disabled (6 ms)
    âœ“ should log debug message when no entities are found (8 ms)

PASS test/redteam/strategies/multilingual.test.ts
  addMultilingual
    âœ“ should preserve harmCategory and modify assertion metrics (79 ms)
    âœ“ should handle test cases without metadata (14 ms)
    âœ“ should translate text and update vars correctly (10 ms)
    âœ“ should increment progress bar when provided (23 ms)
    âœ“ should attempt remote generation first (20 ms)
    âœ“ should preserve harmCategory and modify assertion metrics only for redteam types (7 ms)

PASS test/providers/bam.test.ts
  BAM Provider
    convertResponse
      âœ“ should convert successful response with single result (3 ms)
      âœ“ should convert successful response with multiple results (1 ms)
      âœ“ should handle response with no input token count (1 ms)
      âœ“ should handle empty results array (1 ms)

PASS test/assertions/contextRelevance.test.ts
  handleContextRelevance
    âœ“ should handle valid input (12 ms)
    âœ“ should throw error if vars is missing (38 ms)
    âœ“ should throw error if query is missing (17 ms)
    âœ“ should throw error if context is missing (9 ms)
    âœ“ should use default threshold of 0 if not specified (2 ms)

PASS test/index.test.ts (7.469 s)
  index.ts exports
    âœ“ should export all expected named modules (14 ms)
    âœ“ should export all expected schemas (36 ms)
    âœ“ should not have unexpected exports (9 ms)
    âœ“ redteam should have expected properties (1 ms)
    âœ“ default export should match named exports (12 ms)
    âœ“ should export cache with correct methods (2 ms)
  evaluate function
    âœ“ should handle function prompts correctly (22 ms)
    âœ“ should process different types of prompts correctly (71 ms)
    âœ“ should resolve nested providers (11 ms)
    âœ“ should resolve provider configuration in defaultTest (43 ms)
    âœ“ should resolve provider configuration in individual tests (4 ms)
    âœ“ should resolve provider configuration in assertions (9 ms)
    âœ“ should disable cache when specified (8 ms)
    âœ“ should write results to database when writeLatestResults is true (8 ms)
    âœ“ should write output to file when outputPath is set (1 ms)
    âœ“ should write multiple outputs when outputPath is an array (9 ms)

PASS test/providers/webhook.test.ts
  WebhookProvider
    constructor
      âœ“ should create instance with url (5 ms)
      âœ“ should create instance with url and options (7 ms)
    id
      âœ“ should return webhook url id (1 ms)
    toString
      âœ“ should return string representation (4 ms)
    callApi
      âœ“ should call webhook and return output (3 ms)
      âœ“ should include config in request if provided (1 ms)
      âœ“ should handle fetch errors (1 ms)
      âœ“ should handle invalid response format (11 ms)

PASS test/providers/bedrockUtil.test.ts
  novaOutputFromMessage
    âœ“ should handle tool use blocks (5 ms)
    âœ“ should handle text-only blocks (5 ms)
    âœ“ should handle empty response (5 ms)
  novaParseMessages
    âœ“ should parse JSON messages (2 ms)
    âœ“ should parse plain text messages (7 ms)
    âœ“ should handle single line input as user message (1 ms)
    âœ“ should handle JSON messages with array content (6 ms)

PASS test/util/apiHealth.test.ts
  API Health Utilities
    getRemoteHealthUrl
      âœ“ should return null when remote generation is disabled (2 ms)
      âœ“ should use custom URL when provided (1 ms)
      âœ“ should use cloud config when enabled (5 ms)
      âœ“ should use default URL when no configuration is provided (1 ms)
    checkRemoteHealth
      âœ“ should return OK status when API is healthy (3 ms)
      âœ“ should include custom endpoint message when cloud config is enabled (8 ms)
      âœ“ should handle non-OK response (3 ms)
      âœ“ should handle network errors (6 ms)
      âœ“ should handle malformed JSON (1 ms)

PASS test/assertions/geval.test.ts
  handleGEval
    âœ“ should handle string renderedValue (3 ms)
    âœ“ should handle array renderedValue (1 ms)
    âœ“ should use default threshold if not provided (1 ms)
    âœ“ should throw error for invalid renderedValue type (35 ms)

PASS test/redteam/strategies/likert.test.ts
  likert strategy
    âœ“ should generate likert test cases successfully (21 ms)
    âœ“ should handle API errors gracefully (2 ms)
    âœ“ should throw error when remote generation is disabled (37 ms)
    âœ“ should handle network errors (8 ms)
    âœ“ should handle empty test cases (3 ms)
    âœ“ should include user email in payload (3 ms)

PASS test/prompts/processors/python.test.ts
  processPythonFile
    âœ“ should process a valid Python file without a function name or label (11 ms)
    âœ“ should process a valid Python file with a function name without a label (5 ms)
    âœ“ should process a valid Python file with a label without a function name (3 ms)
    âœ“ should process a valid Python file with a label and function name (1 ms)
    âœ“ should process a valid Python file with config (1 ms)

PASS test/redteam/extraction/purpose.test.ts
  System Purpose Extractor
    âœ“ should use remote generation when enabled (26 ms)
    âœ“ should not fall back to local extraction when remote generation fails (2 ms)
    âœ“ should use local extraction when remote generation is disabled (15 ms)
    âœ“ should extract system purpose when returned without xml tags (4 ms)

FAIL test/util/file.test.ts
  â— Test suite failed to run

    Cannot find module '../../src/util/file.node' from 'test/util/file.test.ts'

       5 | describe('file utilities', () => {
       6 |   // Helper to create platform-appropriate file URLs
    >  7 |   const getFileUrl = (path: string) => {
         |                   ^
       8 |     return process.platform === 'win32'
       9 |       ? `file:///C:/${path.replace(/\\/g, '/')}`
      10 |       : `file:///${path}`;

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (test/util/file.test.ts:7:19)

PASS test/prompts/processors/text.test.ts
  processTxtFile
    âœ“ should process a text file with single prompt and no label (13 ms)
    âœ“ should process a text file with single prompt and a label (21 ms)
    âœ“ should process a text file with multiple prompts and a label (1 ms)
    âœ“ should handle text file with leading and trailing delimiters (1 ms)
    âœ“ should return an empty array for a file with only delimiters (4 ms)
    âœ“ should return an empty array for an empty file (3 ms)

PASS test/redteam/plugins/harmful/aligned.test.ts
  AlignedHarmfulPlugin
    initialization
      âœ“ should create instance with valid parameters (4 ms)
      âœ“ should accept optional config parameter (1 ms)
    template handling
      âœ“ should retrieve correct template for harm category (2 ms)
      âœ“ should throw when category config is not found (12 ms)
    assertion generation
      âœ“ should generate harmful assertions for given prompt (2 ms)
      âœ“ should include harm category in assertions (3 ms)
    test case generation
      âœ“ should create properly structured test cases (22 ms)
      âœ“ should handle empty prompts array (22 ms)
    end-to-end test generation
      âœ“ should generate requested number of test cases (50 ms)
      âœ“ should handle custom examples in config (6 ms)
      âœ“ should handle API errors gracefully (30 ms)

PASS test/types/providers.test.ts
  isApiProvider
    âœ“ should correctly identify valid ApiProvider objects (5 ms)
    âœ“ should correctly identify invalid ApiProvider objects (4 ms)
  isProviderOptions
    âœ“ should correctly identify valid ProviderOptions objects (3 ms)
    âœ“ should correctly identify invalid ProviderOptions objects (49 ms)
    âœ“ should handle edge cases (8 ms)

PASS test/python/wrapper.test.ts
  wrapper
    runPythonCode
      âœ“ should clean up the temporary files after execution (15 ms)
      âœ“ should execute Python code from a string and read the output file (15 ms)

PASS test/assertions/answerRelevance.test.ts
  handleAnswerRelevance
    âœ“ should call matchesAnswerRelevance with correct parameters (24 ms)
    âœ“ should use query from vars if available (8 ms)
    âœ“ should throw error if output is not string (51 ms)
    âœ“ should throw error if prompt is missing (9 ms)
    âœ“ should use default threshold of 0 if not specified (1 ms)

PASS test/redteam/strategies/crescendo.test.ts
  addCrescendo
    âœ“ should add crescendo configuration to test cases (11 ms)
    âœ“ should handle test cases without assertions (2 ms)
    âœ“ should handle empty test cases array
    âœ“ should preserve other test case properties (9 ms)

PASS test/commands/eval/filterErrorTests.test.ts
  filterErrorTests
    âœ“ can filter using vars (3 ms)
    âœ“ can filter using test provider (14 ms)
    âœ“ returns empty array when no error tests (1 ms)

PASS test/prompts/processors/jsonl.test.ts
  processJsonlFile
    âœ“ should process a valid JSONL file without a label (2 ms)
    âœ“ should process a valid JSONL file with a single record without a label (1 ms)
    âœ“ should process a valid JSONL file with a single record and a label (1 ms)
    âœ“ should process a valid JSONL file with multiple records and a label (1 ms)
    âœ“ should throw an error if the file cannot be read (8 ms)

PASS test/redteam/plugins/rbac.test.ts
  RbacPlugin
    âœ“ should generate assertions with correct plugin ID (5 ms)
    âœ“ should generate test cases with correct format (18 ms)
    âœ“ should handle empty response (13 ms)
  RbacGrader
    âœ“ should have correct plugin ID
    âœ“ should render rubric with variables (9 ms)
    âœ“ should get result with default grader (441 ms)
    âœ“ should get suggestions for test case (1 ms)

PASS test/prompts/processors/python.utils.test.ts
  pythonPromptFunction
    âœ“ should call python wrapper function with correct arguments (23 ms)
    âœ“ should call legacy function with correct arguments (2 ms)

PASS test/redteam/strategies/bestOfN.test.ts
  addBestOfNTestCases
    âœ“ should add best-of-n configuration to test cases with basic refusal (21 ms)
    âœ“ should add best-of-n configuration without basic refusal (10 ms)
    âœ“ should handle test cases without assertions (1 ms)
    âœ“ should handle empty test cases array (8 ms)
    âœ“ should preserve additional test case properties (1 ms)

PASS test/assertions/moderation.test.ts
  handleModeration
    âœ“ should pass moderation check (5 ms)
    âœ“ should use redteam final prompt when available (1 ms)

PASS test/assertions/index.test.ts (10.893 s)
  runAssertions
    âœ“ should pass when all assertions pass (66 ms)
    âœ“ should fail when any assertion fails (4 ms)
    âœ“ should handle output as an object (5 ms)
    âœ“ should fail when combined score is less than threshold (5 ms)
    âœ“ should pass when combined score is greater than threshold (4 ms)
    âœ“ preserves default provider (138 ms)
    assert-set
      âœ“ assert-set success (4 ms)
      âœ“ assert-set failure (5 ms)
      âœ“ assert-set threshold success (11 ms)
      âœ“ assert-set threshold failure (6 ms)
      âœ“ assert-set with metric (5 ms)
      âœ“ uses assert-set weight (3 ms)
  runAssertion
    âœ“ should pass when the equality assertion passes (6 ms)
    âœ“ should fail when the equality assertion fails (7 ms)
    âœ“ should pass when the not-equals assertion passes (2 ms)
    âœ“ should fail when the not-equals assertion fails (12 ms)
    âœ“ should handle output as an object (1 ms)
    âœ“ should pass when the equality assertion with object passes (23 ms)
    âœ“ should fail when the equality assertion with object fails (2 ms)
    âœ“ should pass when the equality assertion with object passes with external json (6 ms)
    âœ“ should fail when the equality assertion with object fails with external object (3 ms)
    âœ“ should pass when the is-json assertion passes (2 ms)
    âœ“ should fail when the is-json assertion fails (4 ms)
    âœ“ should pass when the is-json assertion passes with schema (533 ms)
    âœ“ should fail when the is-json assertion fails with schema (3 ms)
    âœ“ should pass when the is-json assertion passes with schema YAML string (21 ms)
    âœ“ should fail when the is-json assertion fails with schema YAML string (16 ms)
    âœ“ should validate JSON with formats using ajv-formats (9 ms)
    âœ“ should validate JSON with formats using ajv-formats - failure (14 ms)
    âœ“ should pass when the is-json assertion passes with external schema (60 ms)
    âœ“ should fail when the is-json assertion fails with external schema (59 ms)
    âœ“ should pass when the contains-json assertion passes (28 ms)
    âœ“ should pass when the contains-json assertion passes with multiple json values (41 ms)
    âœ“ should fail when the contains-json assertion fails (1 ms)
    âœ“ should pass when the contains-json assertion passes with schema (13 ms)
    âœ“ should pass when the contains-json assertion passes with schema with YAML string (13 ms)
    âœ“ should pass when the contains-json assertion passes with external schema (14 ms)
    âœ“ should fail contains-json assertion with invalid data against external schema (32 ms)
    âœ“ should fail contains-json assertion with predefined schema and invalid data (20 ms)
    âœ“ should pass when the javascript assertion passes (9 ms)
    âœ“ should pass a score through when the javascript returns a number (2 ms)
    âœ“ should pass when javascript returns an output string that is smaller than the maximum size threshold (6 ms)
    âœ“ should disregard invalid inputs for assert index (2 ms)
    âœ“ should fail when javascript returns an output string that is larger than the maximum size threshold (4 ms)
    âœ“ should pass when javascript returns a number above threshold (11 ms)
    âœ“ should fail when javascript returns a number below threshold (8 ms)
    âœ“ should set score when javascript returns false (7 ms)
    âœ“ should fail when the javascript assertion fails (5 ms)
    âœ“ should pass when assertion passes - with vars (14 ms)
    âœ“ should pass when the not-contains assertion passes (2 ms)
    âœ“ should fail when the not-contains assertion fails (12 ms)
    âœ“ should pass when the icontains assertion passes (2 ms)
    âœ“ should fail when the icontains assertion fails (5 ms)
    âœ“ should pass when the not-icontains assertion passes (2 ms)
    âœ“ should fail when the not-icontains assertion fails (5 ms)
    âœ“ should pass when the contains-any assertion passes (11 ms)
    âœ“ should fail when the contains-any assertion fails (2 ms)
    âœ“ should pass when the icontains-any assertion passes (13 ms)
    âœ“ should fail when the icontains-any assertion fails (2 ms)
    âœ“ should pass when the contains-all assertion passes (25 ms)
    âœ“ should fail when the contains-all assertion fails (1 ms)
    âœ“ should pass when the icontains-all assertion passes (2 ms)
    âœ“ should fail when the icontains-all assertion fails (2 ms)
    âœ“ should pass when the regex assertion passes (7 ms)
    âœ“ should fail when the regex assertion fails (2 ms)
    âœ“ should pass when the not-regex assertion passes (6 ms)
    âœ“ should fail when the not-regex assertion fails (2 ms)
    âœ“ should pass when the webhook assertion passes (12 ms)
    âœ“ should fail when the webhook assertion fails (2 ms)
    âœ“ should fail when the webhook returns an error (2 ms)
    âœ“ should pass when the rouge-n assertion passes (7 ms)
    âœ“ should fail when the rouge-n assertion fails (5 ms)
    âœ“ should pass when the starts-with assertion passes (1 ms)
    âœ“ should fail when the starts-with assertion fails (2 ms)
    âœ“ should use the provider from the assertion if it exists (31 ms)
    âœ“ should pass when the levenshtein assertion passes (6 ms)
    âœ“ should fail when the levenshtein assertion fails (1 ms)
    SQL assertions
      âœ“ should pass when the is-sql assertion passes (918 ms)
      âœ“ should fail when the is-sql assertion fails (166 ms)
      âœ“ should pass when the not-is-sql assertion passes (163 ms)
      âœ“ should fail when the not-is-sql assertion fails (169 ms)
      âœ“ should pass when the is-sql assertion passes given MySQL Database syntax (181 ms)
      âœ“ should fail when the is-sql assertion fails given MySQL Database syntax (115 ms)
      âœ“ should pass when the is-sql assertion passes given MySQL Database syntax and allowedTables (115 ms)
      âœ“ should fail when the is-sql assertion fails given MySQL Database syntax and allowedTables (133 ms)
      âœ“ should pass when the is-sql assertion passes given MySQL Database syntax and allowedColumns (110 ms)
      âœ“ should fail when the is-sql assertion fails given MySQL Database syntax and allowedColumns (47 ms)
      âœ“ should pass when the is-sql assertion passes given MySQL Database syntax, allowedTables, and allowedColumns (96 ms)
      âœ“ should fail when the is-sql assertion fails given MySQL Database syntax, allowedTables, and allowedColumns (160 ms)
      âœ“ should fail when the is-sql assertion fails due to missing table authority for MySQL Database syntax (129 ms)
      âœ“ should fail when the is-sql assertion fails due to missing authorities for DELETE statement in MySQL Database syntax (73 ms)
      âœ“ should pass when the contains-sql assertion passes (93 ms)
      âœ“ should pass when the contains-sql assertion sees `sql` in code block (72 ms)
      âœ“ should pass when the contains-sql assertion sees sql without code block (39 ms)
      âœ“ should fail when the contains-sql does not contain code block (54 ms)
      âœ“ should fail when the contains-sql does not contain sql in code block (88 ms)
    latency assertion
      âœ“ should pass when the latency assertion passes (1 ms)
      âœ“ should fail when the latency assertion fails (5 ms)
      âœ“ should throw an error when grading result is missing latencyMs (200 ms)
      âœ“ should pass when the latency is 0ms (5 ms)
      âœ“ should throw an error when threshold is not provided (7 ms)
      âœ“ should handle latency equal to threshold (1 ms)
    perplexity assertion
      âœ“ should pass when the perplexity assertion passes (2 ms)
      âœ“ should fail when the perplexity assertion fails (6 ms)
    perplexity-score assertion
      âœ“ should pass when the perplexity-score assertion passes (1 ms)
      âœ“ should fail when the perplexity-score assertion fails (6 ms)
    cost assertion
      âœ“ should pass when the cost is below the threshold (1 ms)
      âœ“ should fail when the cost exceeds the threshold (11 ms)
    Similarity assertion
      âœ“ should pass for a similar assertion with a string value (15 ms)
      âœ“ should fail for a similar assertion with a string value (20 ms)
      âœ“ should pass for a similar assertion with an array of string values (3 ms)
      âœ“ should fail for a similar assertion with an array of string values (2 ms)
    is-xml
      âœ“ should pass when the output is valid XML (39 ms)
      âœ“ should fail when the output is not valid XML (9 ms)
      âœ“ should pass when required elements are present (7 ms)
      âœ“ should fail when required elements are missing (4 ms)
      âœ“ should pass when nested elements are present (6 ms)
      âœ“ should handle inverse assertion correctly (1 ms)
      âœ“ should pass when required elements are specified as an array (5 ms)
      âœ“ should pass when required elements are specified as an object (2 ms)
      âœ“ should throw an error when xml assertion value is invalid (12 ms)
      âœ“ should handle multiple XML blocks in contains-xml assertion (14 ms)
    contains-xml
      âœ“ should pass when the output contains valid XML (2 ms)
      âœ“ should fail when the output does not contain valid XML (1 ms)
      âœ“ should pass when required elements are present in the XML (6 ms)
      âœ“ should fail when required elements are missing in the XML (2 ms)
      âœ“ should pass when nested elements are present in the XML (9 ms)
      âœ“ should handle inverse assertion correctly (1 ms)
      âœ“ should fail inverse assertion when XML is present (11 ms)
    context-relevance assertion
      âœ“ should pass when all required vars are present (4 ms)
      âœ“ should throw an error when vars object is missing (17 ms)
      âœ“ should throw an error when query var is missing (2 ms)
      âœ“ should throw an error when context var is missing (13 ms)
    context-faithfulness assertion
      âœ“ should pass when all required vars are present (1 ms)
      âœ“ should throw an error when vars object is missing (6 ms)
      âœ“ should throw an error when query var is missing (13 ms)
      âœ“ should throw an error when context var is missing (6 ms)
      âœ“ should throw an error when output is not a string (7 ms)
    file references
      âœ“ should handle file reference in string value (1 ms)
      âœ“ should handle file references in array values (13 ms)
      âœ“ should handle file reference in object value (4 ms)
  validateXml
    âœ“ should validate a simple valid XML string (1 ms)
    âœ“ should invalidate a malformed XML string (1 ms)
    âœ“ should validate XML with attributes (2 ms)
    âœ“ should validate XML with namespaces (1 ms)
    âœ“ should validate when all required elements are present (1 ms)
    âœ“ should invalidate when a required element is missing (1 ms)
    âœ“ should validate nested elements correctly (1 ms)
    âœ“ should invalidate when a nested required element is missing (1 ms)
    âœ“ should handle empty elements correctly (1 ms)
    âœ“ should validate XML with multiple siblings (1 ms)
    âœ“ should handle XML with CDATA sections (27 ms)
    âœ“ should validate XML with processing instructions (1 ms)
    âœ“ should handle XML with comments (1 ms)
    âœ“ should validate the example XML structure (2 ms)
  containsXml
    âœ“ should return true when valid XML is present
    âœ“ should return false when no XML is present (1 ms)
    âœ“ should validate required elements (1 ms)
    âœ“ should return false when required elements are missing
    âœ“ should handle multiple XML fragments (1 ms)

PASS test/esm.test.ts
  ESM utilities
    importModule
      âœ“ imports JavaScript modules (6 ms)
      âœ“ imports TypeScript modules (120 ms)
      âœ“ handles absolute paths (8 ms)

PASS test/redteam/strategies/hex.test.ts
  addHexEncoding
    âœ“ should encode variable value as hex and append /Hex to metrics (3 ms)
    âœ“ should handle empty string (2 ms)
    âœ“ should handle special characters (1 ms)
    âœ“ should handle numbers (1 ms)
    âœ“ should handle test case without assertions (1 ms)

PASS test/redteam/plugins/crossSessionLeak.test.ts
  CrossSessionLeakPlugin
    âœ“ should generate test cases correctly with proper templating (185 ms)
  CrossSessionLeakGrader
    âœ“ should detect a leak correctly (1 ms)
    âœ“ should pass when no leak is detected (2 ms)

PASS test/redteam/providers/iterative.test.ts
  RedteamIterativeProvider
    constructor
      âœ“ should throw if injectVar is not provided (217 ms)
      âœ“ should create instance with valid config (26 ms)
      âœ“ should use default numIterations if not provided (1 ms)
      âœ“ should use configured numIterations when provided (9 ms)
      âœ“ should use environment variable for numIterations if set (1 ms)
    runRedteamConversation
      âœ“ should stop iteration when score reaches 10 (1439 ms)

PASS test/prompts/processors/markdown.test.ts
  processMarkdownFile
    âœ“ should process a valid Markdown file without a label (2 ms)
    âœ“ should process a valid Markdown file with a label (5 ms)
    âœ“ should truncate the label for long Markdown files (1 ms)
    âœ“ should throw an error if the file cannot be read (24 ms)

PASS test/providers/portkey.test.ts
  toKebabCase
    âœ“ should convert simple camelCase to kebab-case (5 ms)
    âœ“ should handle empty string (1 ms)
    âœ“ should handle single word (1 ms)
    âœ“ should preserve existing kebab-case (1 ms)
    âœ“ should handle single letters
  getPortkeyHeaders
    âœ“ should return headers with correct format for portkey config keys (5 ms)
    âœ“ should ignore config keys with undefined or null values (1 ms)
    âœ“ should handle empty config object (1 ms)
    âœ“ should handle non-portkey config keys without modification (1 ms)
    âœ“ should handle mixed portkey and non-portkey config keys
    âœ“ should handle boolean values
    âœ“ should handle numeric values (5 ms)

PASS test/updates.test.ts
  getLatestVersion
    âœ“ should return the latest version of the package (2 ms)
    âœ“ should throw an error if the response is not ok (11 ms)
  checkForUpdates
    âœ“ should log an update message if a newer version is available - minor ver (8 ms)
    âœ“ should log an update message if a newer version is available - major ver (1 ms)
    âœ“ should not log an update message if the current version is up to date (4 ms)

PASS test/commands/eval/filterFailingTests.test.ts
  filterFailingTests
    âœ“ can filter using vars (12 ms)
    âœ“ can filter using test provider (2 ms)
    âœ“ returns empty array when no failing tests (4 ms)

PASS test/redteam/strategies/index.test.ts
  validateStrategies
    âœ“ should validate valid strategies (6 ms)
    âœ“ should validate basic strategy with enabled config
    âœ“ should throw error for invalid basic strategy config (59 ms)
    âœ“ should skip validation for file:// strategies (1 ms)
    âœ“ should exit for invalid strategies (3 ms)
  loadStrategy
    âœ“ should load predefined strategy (1 ms)
    âœ“ should throw error for non-existent strategy (1 ms)
    âœ“ should load custom file strategy (5 ms)
    âœ“ should throw error for non-js custom file (2 ms)
    âœ“ should throw error for invalid custom strategy (4 ms)
    âœ“ should use absolute path for custom strategy (1 ms)
    âœ“ should use relative path from basePath for custom strategy (1 ms)

PASS test/types/index.test.ts
  isGradingResult
    âœ“ should return true for valid grading result object (15 ms)
    âœ“ should return true for grading result with optional fields (12 ms)
    âœ“ should return false for null (1 ms)
    âœ“ should return false for non-object
    âœ“ should return false if missing required fields (6 ms)
    âœ“ should return false if fields have wrong types
    âœ“ should return false if optional fields have wrong types (10 ms)

PASS test/redteam/plugins/custom.test.ts
  CustomPlugin
    âœ“ should generate test cases correctly with proper templating (102 ms)
    âœ“ should use the correct template for getTemplate (15 ms)
    âœ“ should render the grader template with the correct purpose (4 ms)
  loadCustomPluginDefinition
    âœ“ should load a valid custom plugin definition (1 ms)
    âœ“ should throw an error for an invalid custom plugin definition (100 ms)
    âœ“ should throw an error when the plugin definition is missing a required field (7 ms)
    âœ“ should throw an error when the plugin definition contains extra fields (15 ms)

PASS test/util/invariant.test.ts
  invariant
    âœ“ should not throw when condition is true (14 ms)
    âœ“ should throw when condition is false (24 ms)
    âœ“ should include the provided message in the error (2 ms)
    âœ“ should support message callback functions (2 ms)
    âœ“ should work for type narrowing (4 ms)

PASS test/redteam/commands/init.test.ts
  renderRedteamConfig
    âœ“ should generate valid YAML that conforms to RedteamFileConfig (81 ms)
    âœ“ should handle minimal configuration (55 ms)
    âœ“ should include all provided plugins and strategies (70 ms)
    âœ“ should handle custom provider configuration (37 ms)

PASS test/redteam/plugins/harmbench.test.ts
  HarmbenchPlugin
    âœ“ should generate test cases correctly from fetched dataset (51 ms)
    âœ“ should handle fetch errors gracefully (4 ms)
  HarmbenchGrader
    âœ“ should pass when content is safe (7 ms)

PASS test/assertions/validateAssertions.test.ts
  validateAssertions
    asssert-set
      âœ“ does not fail on valid assert-set (2 ms)
      âœ“ has assert (25 ms)
      âœ“ has assert as an array (2 ms)
      âœ“ does not have child assert-sets (12 ms)

PASS test/providers/defaults.test.ts
  Provider override tests
    âœ“ should override all completion providers when setDefaultCompletionProviders is called (25 ms)
    âœ“ should override embedding provider when setDefaultEmbeddingProviders is called (15 ms)
    âœ“ should allow both completion and embedding provider overrides simultaneously (7 ms)

PASS test/commands/eval/filterProviders.test.ts
  filterProviders
    âœ“ should return all providers when no filter is provided (7 ms)
    âœ“ should filter providers by id (6 ms)
    âœ“ should filter providers by label (1 ms)
    âœ“ should return empty array when no providers match the filter (1 ms)
    âœ“ should handle regex patterns in filter (1 ms)
    âœ“ should handle providers without labels (1 ms)

PASS test/prompts/processors/json.test.ts
  processJsonFile
    âœ“ should process a valid JSON file without a label (7 ms)
    âœ“ should process a valid JSON file with a label (9 ms)
    âœ“ should throw an error if the file cannot be read (19 ms)

PASS test/redteam/strategies/goat.test.ts
  GOAT Strategy
    âœ“ should add GOAT configuration to test cases (2 ms)
    âœ“ should preserve original test case properties (1 ms)

PASS test/redteam/strategies/rot13.test.ts
  addRot13
    âœ“ should encode the inject variable using ROT13 (11 ms)
    âœ“ should handle uppercase and lowercase letters (1 ms)
    âœ“ should not change non-alphabetic characters (1 ms)

PASS test/redteam/plugins/pluginDocumentation.test.ts
  Plugin Documentation
    âœ“ should have matching plugin and documentation files (31 ms)
    âœ“ should have correct naming conventions for plugins and docs (27 ms)

PASS test/redteam/strategies/leetspeak.test.ts
  addLeetspeak
    âœ“ should convert the inject variable to leetspeak (2 ms)
    âœ“ should handle uppercase and lowercase letters (1 ms)

PASS test/checkNodeVersion.test.ts
  checkNodeVersion
    âœ“ should handle version strings correctly and throw if required version is not met (8 ms)
    âœ“ should not throw if Node.js version is supported (1 ms)
    âœ“ should log a warning if Node.js version format is unexpected (2 ms)

PASS test/redteam/plugins/imitation.test.ts
  ImitationGrader
    âœ“ should have the correct id (2 ms)
    âœ“ should render the rubric with correct structure and variables (24 ms)
    âœ“ should include all provided entities in the rubric (8 ms)
    âœ“ should handle cases with no allowed entities (28 ms)

PASS test/assertions/json.test.ts
  getAjv
    âœ“ should create an Ajv instance with default options (5 ms)
    âœ“ should disable strict mode when PROMPTFOO_DISABLE_AJV_STRICT_MODE is set (2 ms)
    âœ“ should add formats to the Ajv instance (4 ms)
    âœ“ should reuse the same instance on subsequent calls (2 ms)

PASS test/redteam/strategies/retry.test.ts
  deduplicateTests
    âœ“ should deduplicate test cases based on vars (2 ms)
    âœ“ should handle empty test cases array (5 ms)
    âœ“ should handle test cases with no vars (1 ms)
    âœ“ should preserve non-vars properties (1 ms)

PASS test/prompts/processors/string.test.ts
  processString
    âœ“ should process a valid string prompt without a label (2 ms)
    âœ“ should process a valid string prompt with a label (1 ms)

PASS test/providers/openai/index.test.ts
  OpenAI Provider
    OpenAiGenericProvider
      âœ“ should generate correct API URL (9 ms)
      âœ“ should use custom API host (1 ms)
      âœ“ should get organization
      âœ“ should get API key

PASS test/redteam/strategies/base64.test.ts
  addBase64Encoding
    âœ“ should encode the inject variable to base64 (2 ms)

PASS test/utils/text.test.ts
  ellipsize
    âœ“ should not modify string shorter than maxLen (1 ms)
    âœ“ should truncate string and add ellipsis when longer than maxLen (1 ms)
    âœ“ should handle string equal to maxLen (1 ms)
    âœ“ should handle very short maxLen
    âœ“ should handle empty string (1 ms)

PASS test/account.test.ts
  accounts module
    getUserEmail
      âœ“ should return the email from global config (1 ms)
      âœ“ should return null if no email is set in global config (1 ms)
    setUserEmail
      âœ“ should write the email to global config (1 ms)
    getAuthor
      âœ“ should return the author from environment variable (1 ms)
      âœ“ should return the email if environment variable is not set (11 ms)
      âœ“ should return null if neither environment variable nor email is set (1 ms)

PASS test/redteam/plugins/asciiSmuggling.test.ts
  AsciiSmugglingGrader
    âœ“ should detect when model follows injected instructions (2 ms)
    âœ“ should pass when model ignores injected instructions (1 ms)
    âœ“ should handle missing test string in metadata (1 ms)
    âœ“ should handle undefined metadata (1 ms)
    âœ“ should return empty rubric (1 ms)

PASS test/providers/openai/util.test.ts
  failApiCall
    âœ“ should format OpenAI API errors (2 ms)
    âœ“ should format generic errors
  getTokenUsage
    âœ“ should return token usage for non-cached response
    âœ“ should return cached token usage (1 ms)
    âœ“ should handle missing usage data
  calculateOpenAICost
    âœ“ should calculate cost correctly
    âœ“ should handle unknown models

PASS test/redteam/plugins/competitors.test.ts
  CompetitorsGrader
    getSuggestions
      âœ“ should return suggestions with competitor mentions allowed (4 ms)
      âœ“ should return suggestions with competitor mentions disallowed (2 ms)
      âœ“ should handle undefined pluginConfig (1 ms)

PASS test/providers/xai.test.ts
  xAI Provider
    âœ“ throws an error if no model name is provided (7 ms)
    âœ“ creates an xAI provider with specified model (3 ms)
    âœ“ sets the correct API base URL and API key environment variable (1 ms)
    âœ“ merges provided options with xAI-specific config (1 ms)

PASS test/providers/togetherai.test.ts
  createTogetherAiProvider
    âœ“ should create a chat completion provider when type is chat (4 ms)
    âœ“ should create a completion provider when type is completion (1 ms)
    âœ“ should create an embedding provider when type is embedding (1 ms)
    âœ“ should create an embedding provider when type is embeddings (1 ms)
    âœ“ should default to chat completion provider when no type is specified (1 ms)
    âœ“ should pass correct configuration to the provider (2 ms)
    âœ“ should handle model names with colons (1 ms)

PASS test/redteam/plugins/contracts.test.ts
  ContractPlugin
    âœ“ should generate test cases (13 ms)
    âœ“ should handle empty response from provider (9 ms)
    âœ“ should handle error response from provider (9 ms)
  ContractsGrader
    âœ“ should render rubric with variables (5 ms)
    âœ“ should generate suggestions (2 ms)
    âœ“ should have correct plugin ID

PASS test/redteam/plugins/harmful/common.test.ts
  harmful plugin
    getHarmfulAssertions
      âœ“ should return basic assertion for privacy category (4 ms)
      âœ“ should return basic assertion for non-privacy category (1 ms)
      âœ“ should return only basic assertions when moderation is disabled (1 ms)
      âœ“ should prioritize Replicate over OpenAI when both keys are present (1 ms)
      âœ“ should handle REPLICATE_API_TOKEN (2 ms)
    createTestCase
      âœ“ should create test case with single line output (1 ms)
      âœ“ should handle multiline output
      âœ“ should handle whitespace in output (1 ms)
      âœ“ should use harm category as fallback when not in HARM_PLUGINS (1 ms)
    harm categories and graders
      âœ“ should have corresponding graders for all harmful categories (9 ms)

PASS test/providers/openai/defaults.test.ts
  OpenAI default providers
    DefaultEmbeddingProvider
      âœ“ should use correct model version (1 ms)
    DefaultGradingProvider
      âœ“ should use correct model version and configuration (1 ms)
    DefaultGradingJsonProvider
      âœ“ should use correct model version and JSON configuration (1 ms)
    DefaultSuggestionsProvider
      âœ“ should use correct model version (1 ms)
    DefaultModerationProvider
      âœ“ should use correct model version

PASS test/redteam/plugins/beavertails.test.ts
  fetchAllDatasets
    âœ“ should fetch and filter datasets correctly (3 ms)
    âœ“ should handle empty dataset
    âœ“ should handle invalid test cases (1 ms)
    âœ“ should handle fetch errors (1 ms)

PASS test/redteam/plugins/indirectPromptInjection.test.ts
  IndirectPromptInjectionGrader
    getSuggestions
      âœ“ should throw error if renderedValue is not provided (10 ms)
      âœ“ should throw error if renderedValue is not a string (2 ms)
      âœ“ should return array with datamarking and encoding suggestions (2 ms)
      âœ“ should generate correct datamarking suggestion (2 ms)
      âœ“ should generate correct encoding suggestion (1 ms)

PASS test/redteam/plugins/shellInjection.test.ts
  ShellInjectionPlugin
    âœ“ should generate template with default examples when no examples provided (1 ms)
    âœ“ should return correct assertions for a prompt (1 ms)
  ShellInjectionGrader
    âœ“ should have correct ID
    âœ“ should have non-empty rubric (1 ms)
    âœ“ should include key evaluation criteria in rubric (1 ms)

PASS test/providers/openai/completion.test.ts
  OpenAI Provider
    OpenAiCompletionProvider
      âœ“ should call API successfully with text completion (3 ms)

PASS test/providers/openai/embedding.test.ts
  OpenAI Provider
    OpenAiEmbeddingProvider
      âœ“ should call embedding API successfully (3 ms)
      âœ“ should handle API errors (4 ms)

PASS test/redteam/graders.test.ts
  getGraderById
    âœ“ should return correct grader for valid ID (2 ms)
    âœ“ should return undefined for invalid ID (1 ms)
    âœ“ should return undefined for empty ID

PASS test/server/providers.test.ts
  providersRouter
    âœ“ should parse and load the provider with JSON body (54 ms)
    âœ“ should parse and load the provider with YAML body (9 ms)
    âœ“ should validate provider config using Zod schema (8 ms)
    âœ“ should handle non-JSON content types correctly (6 ms)

PASS test/python/python.integration.test.ts
  pythonUtils Integration Tests
    âœ“ should be able to call Python directly (58 ms)
    âœ“ should successfully run a simple Python script (690 ms)
    âœ“ should handle multiple arguments (299 ms)
    âœ“ should handle empty string argument (694 ms)
    âœ“ should handle non-string argument (473 ms)
    âœ“ should throw an error for non-existent script (515 ms)
    âœ“ should handle Python script that prints to stdout (326 ms)
    âœ“ should handle class methods (294 ms)
    âœ“ should handle async functions (515 ms)
    âœ“ should handle scripts with imports (181 ms)
    âœ“ should handle scripts with environment variables (103 ms)
    âœ“ should log debug messages (95 ms)

FAIL test/util/listPrevious.test.ts
  listPreviousResults
    âœ• returns previous results (3 ms)

  â— listPreviousResults â€º returns previous results

    Could not locate the bindings file. Tried:
     â†’ /app/node_modules/better-sqlite3/build/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/Debug/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/Release/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/build/default/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/compiled/22.15.0/linux/x64/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

      27 | export function getDb() {
      28 |   if (!dbInstance) {
    > 29 |     const sqlite = new Database(process.env.IS_TESTING ? ':memory:' : getDbPath());
         |                    ^
      30 |     const logger = new DefaultLogger({ writer: new DrizzleLogWriter() });
      31 |     dbInstance = drizzle(sqlite, { logger });
      32 |   }

      at bindings (node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/better-sqlite3/lib/database.js:48:64)
      at getDb (src/database/index.ts:29:20)
      at Function.create (src/models/eval.ts:163:21)
      at Function.create (test/factories/evalFactory.ts:10:30)
      at Object.create (test/util/listPrevious.test.ts:11:37)

PASS test/server/server.test.ts
  /api/remote-health endpoint
    âœ“ should return disabled status when remote generation is disabled (41 ms)
    âœ“ should return health check result when enabled (7 ms)
    âœ“ should handle errors from health check (6 ms)
    âœ“ should use custom URL from environment (6 ms)
    âœ“ should use cloud config URL when enabled (6 ms)

Summary of all failing tests
FAIL test/util/file.test.ts
  â— Test suite failed to run

    Cannot find module '../../src/util/file.node' from 'test/util/file.test.ts'

       5 | describe('file utilities', () => {
       6 |   // Helper to create platform-appropriate file URLs
    >  7 |   const getFileUrl = (path: string) => {
         |                   ^
       8 |     return process.platform === 'win32'
       9 |       ? `file:///C:/${path.replace(/\\/g, '/')}`
      10 |       : `file:///${path}`;

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (test/util/file.test.ts:7:19)

FAIL test/util/listPrevious.test.ts
  â— listPreviousResults â€º returns previous results

    Could not locate the bindings file. Tried:
     â†’ /app/node_modules/better-sqlite3/build/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/Debug/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/Release/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/build/default/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/compiled/22.15.0/linux/x64/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     â†’ /app/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

      27 | export function getDb() {
      28 |   if (!dbInstance) {
    > 29 |     const sqlite = new Database(process.env.IS_TESTING ? ':memory:' : getDbPath());
         |                    ^
      30 |     const logger = new DefaultLogger({ writer: new DrizzleLogWriter() });
      31 |     dbInstance = drizzle(sqlite, { logger });
      32 |   }

      at bindings (node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/better-sqlite3/lib/database.js:48:64)
      at getDb (src/database/index.ts:29:20)
      at Function.create (src/models/eval.ts:163:21)
      at Function.create (test/factories/evalFactory.ts:10:30)
      at Object.create (test/util/listPrevious.test.ts:11:37)


Test Suites: 2 failed, 165 passed, 167 total
Tests:       1 failed, 2537 passed, 2538 total
Snapshots:   0 total
Time:        13.653 s
