Running all tests...
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Got a `.js` file to compile while `allowJs` option is not set to `true` (file: /app/.jest/setEnvVars.js). To fix this:
  - if you want TypeScript to process JS files, set `allowJs` to `true` in your TypeScript config (usually tsconfig.json)
  - if you do not want TypeScript to process your `.js` files, in your Jest config change the `transform` key which value is `ts-jest` so that it does not match `.js` files anymore
FAIL examples/jest-integration/index.test.ts
  Ã¢â€”Â Test suite failed to run

    [96mexamples/jest-integration/index.test.ts[0m:[93m3[0m:[93m36[0m - [91merror[0m[90m TS2307: [0mCannot find module '../../dist/types.js' or its corresponding type declarations.

    [7m3[0m import type { GradingConfig } from '../../dist/types.js';
    [7m [0m [91m                                   ~~~~~~~~~~~~~~~~~~~~~[0m

Creating cache folder at /root/.promptfoo/cache.
Creating cache folder at /root/.promptfoo/cache.
Cache is disabled.
Cache is disabled.
Cache is disabled.
PASS test/cache.test.ts
  fetchJsonWithCache
    Ã¢Å“â€œ should not cache data with failed request (11 ms)
    Ã¢Å“â€œ should fetch data with cache enabled (2 ms)
    Ã¢Å“â€œ should fetch data with cache enabled after previous test (1 ms)
    Ã¢Å“â€œ should fetch data without cache for a single test (1 ms)
    Ã¢Å“â€œ should still fetch data without cache for a single test (2 ms)

PASS test/providers.test.ts
  providers
    Ã¢Å“â€œ OpenAiCompletionProvider callApi (11 ms)
    Ã¢Å“â€œ OpenAiChatCompletionProvider callApi (3 ms)
    Ã¢Å“â€œ OpenAiChatCompletionProvider callApi with cache disabled (2 ms)
    Ã¢Å“â€œ loadApiProvider with openai:chat (1 ms)
    Ã¢Å“â€œ loadApiProvider with openai:completion (1 ms)
    Ã¢Å“â€œ loadApiProvider with openai:chat:modelName
    Ã¢Å“â€œ loadApiProvider with openai:completion:modelName (6 ms)

PASS test/util.test.ts
  util
    Ã¢Å“â€œ readPrompts with single prompt file (6 ms)
    Ã¢Å“â€œ readPrompts with multiple prompt files (1 ms)
    Ã¢Å“â€œ readPrompts with directory (1 ms)
    Ã¢Å“â€œ readPrompts with empty input (1 ms)
    Ã¢Å“â€œ readPrompts with map input (1 ms)
    Ã¢Å“â€œ readVars with CSV input (7 ms)
    Ã¢Å“â€œ readVars with JSON input (1 ms)
    Ã¢Å“â€œ readVars with YAML input (7 ms)
    Ã¢Å“â€œ writeOutput with CSV output (3 ms)
    Ã¢Å“â€œ writeOutput with JSON output (1 ms)
    Ã¢Å“â€œ writeOutput with YAML output (5 ms)
  readTests
    Ã¢Å“â€œ readTests with no input (1 ms)
    Ã¢Å“â€œ readTests with string input (CSV file path) (2 ms)
    Ã¢Å“â€œ readTests with array input (TestCase[]) (1 ms)

FAIL test/assertions.test.ts
  runAssertions
    Ã¢Å“â€œ should pass when all assertions pass (3 ms)
    Ã¢Å“â€œ should fail when any assertion fails (1 ms)
  runAssertion
    Ã¢Å“â€œ should pass when the equality assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the equality assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the is-json assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the is-json assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the contains-json assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the contains-json assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the function assertion passes
    Ã¢Å“â€œ should fail when the function assertion fails
    Ã¢Å“â€¢ should pass when the function assertion passes - with vars (2 ms)
    Ã¢Å“â€¢ should fail when the function does not match vars (7 ms)
    Ã¢Å“â€œ should pass when the not-contains assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the not-contains assertion fails
    Ã¢Å“â€œ should pass when the icontains assertion passes (6 ms)
    Ã¢Å“â€œ should fail when the icontains assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the not-icontains assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the not-icontains assertion fails
    Ã¢Å“â€œ should pass when the contains-any assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the contains-any assertion fails
    Ã¢Å“â€œ should pass when the contains-all assertion passes
    Ã¢Å“â€œ should fail when the contains-all assertion fails
    Ã¢Å“â€œ should pass when the regex assertion passes
    Ã¢Å“â€œ should fail when the regex assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the not-regex assertion passes
    Ã¢Å“â€œ should fail when the not-regex assertion fails (1 ms)
  assertionFromString
    Ã¢Å“â€œ should create an equality assertion
    Ã¢Å“â€œ should create an is-json assertion
    Ã¢Å“â€œ should create an contains-json assertion
    Ã¢Å“â€œ should create a function assertion (1 ms)
    Ã¢Å“â€œ should create a similarity assertion
    Ã¢Å“â€œ should create a contains assertion (1 ms)
    Ã¢Å“â€œ should create a not-contains assertion
    Ã¢Å“â€œ should create a contains-any assertion (1 ms)
    Ã¢Å“â€œ should create a contains-all assertion
    Ã¢Å“â€œ should create a regex assertion (1 ms)
    Ã¢Å“â€œ should create a not-regex assertion
    Ã¢Å“â€œ should create an icontains assertion
    Ã¢Å“â€œ should create a not-icontains assertion
  matchesSimilarity
    Ã¢Å“â€œ should pass when similarity is above the threshold (2 ms)
    Ã¢Å“â€œ should fail when similarity is below the threshold
    Ã¢Å“â€œ should fail when inverted similarity is above the threshold (1 ms)
    Ã¢Å“â€œ should pass when inverted similarity is below the threshold
  matchesLlmRubric
    Ã¢Å“â€œ should pass when the grading provider returns a passing result (6 ms)
    Ã¢Å“â€œ should fail when the grading provider returns a failing result (2 ms)

  Ã¢â€”Â runAssertion Ã¢â‚¬Âº should pass when the function assertion passes - with vars

    expect(received).toBeTruthy()

    Received: false

      164 |       output,
      165 |     );
    > 166 |     expect(result.pass).toBeTruthy();
          |                         ^
      167 |     expect(result.reason).toBe('Assertion passed');
      168 |   });
      169 |

      at Object.<anonymous> (test/assertions.test.ts:166:25)

  Ã¢â€”Â runAssertion Ã¢â‚¬Âº should fail when the function does not match vars

    expect(received).toBe(expected) // Object.is equality

    - Expected  - 1
    + Received  + 1

    - Custom function returned false
    + Custom function threw error: context is not defined
      output === "Expected output" && context.vars.foo === "something else"

      181 |     );
      182 |     expect(result.pass).toBeFalsy();
    > 183 |     expect(result.reason).toBe(
          |                           ^
      184 |       'Custom function returned false\noutput === "Expected output" && context.vars.foo === "something else"',
      185 |     );
      186 |   });

      at Object.<anonymous> (test/assertions.test.ts:183:27)

Test Suites: 2 failed, 3 passed, 5 total
Tests:       2 failed, 69 passed, 71 total
Snapshots:   0 total
Time:        5.339 s
