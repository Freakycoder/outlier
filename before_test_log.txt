Running all tests...
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
ts-jest[ts-jest-transformer] (WARN) Got a `.js` file to compile while `allowJs` option is not set to `true` (file: /app/.jest/setEnvVars.js). To fix this:
  - if you want TypeScript to process JS files, set `allowJs` to `true` in your TypeScript config (usually tsconfig.json)
  - if you do not want TypeScript to process your `.js` files, in your Jest config change the `transform` key which value is `ts-jest` so that it does not match `.js` files anymore
PASS test/telemetry.test.ts
  Telemetry
    Ã¢Å“â€œ should not record events when telemetry is disabled (3 ms)
    Ã¢Å“â€œ should record events when telemetry is enabled (2 ms)
    Ã¢Å“â€œ should send events and clear events array when telemetry is enabled and send is called (2 ms)
    Ã¢Å“â€œ should not send events when telemetry is disabled and send is called (1 ms)

FAIL examples/jest-integration/index.test.ts
  Ã¢â€”Â Test suite failed to run

    [96mexamples/jest-integration/index.test.ts[0m:[93m3[0m:[93m36[0m - [91merror[0m[90m TS2307: [0mCannot find module '../../dist/types.js' or its corresponding type declarations.

    [7m3[0m import type { GradingConfig } from '../../dist/types.js';
    [7m [0m [91m                                   ~~~~~~~~~~~~~~~~~~~~~[0m



Ã¢Å¡ Ã¯Â¸Â The current version of promptfoo 0.11.0 is lower than the latest available version 0.12.0.

Please run npx promptfoo@latest or npm install -g promptfoo@latest to update.




Ã¢Å¡ Ã¯Â¸Â The current version of promptfoo 0.11.0 is lower than the latest available version 1.1.0.

Please run npx promptfoo@latest or npm install -g promptfoo@latest to update.


PASS test/updates.test.ts
  getLatestVersion
    Ã¢Å“â€œ should return the latest version of the package (3 ms)
    Ã¢Å“â€œ should throw an error if the response is not ok (10 ms)
  checkForUpdates
    Ã¢Å“â€œ should log an update message if a newer version is available - minor ver (5 ms)
    Ã¢Å“â€œ should log an update message if a newer version is available - major ver (2 ms)
    Ã¢Å“â€œ should not log an update message if the current version is up to date (1 ms)

Creating cache folder at /root/.promptfoo/cache.
Cache is disabled.
Cache is disabled.
PASS test/cache.test.ts (5.563 s)
  fetchJsonWithCache
    Ã¢Å“â€œ should not cache data with failed request (8 ms)
    Ã¢Å“â€œ should fetch data with cache enabled (2 ms)
    Ã¢Å“â€œ should fetch data with cache enabled after previous test (11 ms)
    Ã¢Å“â€œ should fetch data without cache for a single test (2 ms)
    Ã¢Å“â€œ should still fetch data without cache for a single test (1 ms)

Cache is disabled.
Using unknown OpenAI chat model: abc123
Using unknown OpenAI completion model: def456
PASS test/providers.test.ts (5.585 s)
  providers
    Ã¢Å“â€œ OpenAiCompletionProvider callApi (12 ms)
    Ã¢Å“â€œ OpenAiChatCompletionProvider callApi (2 ms)
    Ã¢Å“â€œ OpenAiChatCompletionProvider callApi with cache disabled (2 ms)
    Ã¢Å“â€œ loadApiProvider with openai:chat (1 ms)
    Ã¢Å“â€œ loadApiProvider with openai:completion
    Ã¢Å“â€œ loadApiProvider with openai:chat:modelName
    Ã¢Å“â€œ loadApiProvider with openai:completion:modelName (1 ms)
    Ã¢Å“â€œ loadApiProvider with RawProviderConfig
    Ã¢Å“â€œ loadApiProviders with RawProviderConfig[] (2 ms)

FAIL test/util.test.ts (5.7 s)
  util
    Ã¢Å“â€œ readPrompts with single prompt file (5 ms)
    Ã¢Å“â€œ readPrompts with multiple prompt files (2 ms)
    Ã¢Å“â€œ readPrompts with directory (2 ms)
    Ã¢Å“â€œ readPrompts with empty input (1 ms)
    Ã¢Å“â€œ readPrompts with map input
    Ã¢Å“â€¢ readPrompts with JSONL file (8 ms)
    Ã¢Å“â€œ readVars with CSV input (6 ms)
    Ã¢Å“â€œ readVars with JSON input (1 ms)
    Ã¢Å“â€œ readVars with YAML input (5 ms)
    Ã¢Å“â€œ writeOutput with CSV output (3 ms)
    Ã¢Å“â€œ writeOutput with JSON output
    Ã¢Å“â€œ writeOutput with YAML output (4 ms)
  readTests
    Ã¢Å“â€œ readTests with no input (1 ms)
    Ã¢Å“â€œ readTests with string input (CSV file path) (3 ms)
    Ã¢Å“â€œ readTests with array input (TestCase[]) (1 ms)

  Ã¢â€”Â util Ã¢â‚¬Âº readPrompts with JSONL file

    expect(received).toEqual(expected) // deep equality

    - Expected  - 6
    + Received  + 4

      Array [
        Object {
    -     "display": "[{\"role\":\"system\",\"content\":\"You are a helpful assistant.\"},{\"role\":\"user\",\"content\":\"Who won the world series in {{ year }}?\"}]",
    -     "raw": "[{\"role\":\"system\",\"content\":\"You are a helpful assistant.\"},{\"role\":\"user\",\"content\":\"Who won the world series in {{ year }}?\"}]",
    -   },
    -   Object {
    -     "display": "[{\"role\":\"system\",\"content\":\"You are a helpful assistant.\"},{\"role\":\"user\",\"content\":\"Who won the superbowl in {{ year }}?\"}]",
    -     "raw": "[{\"role\":\"system\",\"content\":\"You are a helpful assistant.\"},{\"role\":\"user\",\"content\":\"Who won the superbowl in {{ year }}?\"}]",
    +     "display": "[{\"role\":\"system\",\"content\":\"You are a helpful assistant.\"},{\"role\":\"user\",\"content\":\"Who won the world series in {{ year }}?\"}]
    + [{\"role\":\"system\",\"content\":\"You are a helpful assistant.\"},{\"role\":\"user\",\"content\":\"Who won the superbowl in {{ year }}?\"}]",
    +     "raw": "[{\"role\":\"system\",\"content\":\"You are a helpful assistant.\"},{\"role\":\"user\",\"content\":\"Who won the world series in {{ year }}?\"}]
    + [{\"role\":\"system\",\"content\":\"You are a helpful assistant.\"},{\"role\":\"user\",\"content\":\"Who won the superbowl in {{ year }}?\"}]",
        },
      ]

      120 |
      121 |     expect(fs.readFileSync).toHaveBeenCalledTimes(1);
    > 122 |     expect(result).toEqual([toPrompt(JSON.stringify(data[0])), toPrompt(JSON.stringify(data[1]))]);
          |                    ^
      123 |   });
      124 |
      125 |   test('readVars with CSV input', async () => {

      at Object.<anonymous> (test/util.test.ts:122:20)

PASS test/assertions.test.ts (5.687 s)
  runAssertions
    Ã¢Å“â€œ should pass when all assertions pass (3 ms)
    Ã¢Å“â€œ should fail when any assertion fails (1 ms)
  runAssertion
    Ã¢Å“â€œ should pass when the equality assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the equality assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the is-json assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the is-json assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the contains-json assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the contains-json assertion fails
    Ã¢Å“â€œ should pass when the function assertion passes
    Ã¢Å“â€œ should fail when the function assertion fails
    Ã¢Å“â€œ should pass when the function assertion passes - with vars
    Ã¢Å“â€œ should fail when the function does not match vars (1 ms)
    Ã¢Å“â€œ should pass when the not-contains assertion passes
    Ã¢Å“â€œ should fail when the not-contains assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the icontains assertion passes
    Ã¢Å“â€œ should fail when the icontains assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the not-icontains assertion passes
    Ã¢Å“â€œ should fail when the not-icontains assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the contains-any assertion passes
    Ã¢Å“â€œ should fail when the contains-any assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the contains-all assertion passes
    Ã¢Å“â€œ should fail when the contains-all assertion fails (1 ms)
    Ã¢Å“â€œ should pass when the regex assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the regex assertion fails
    Ã¢Å“â€œ should pass when the not-regex assertion passes
    Ã¢Å“â€œ should fail when the not-regex assertion fails
    Ã¢Å“â€œ should pass when the webhook assertion passes (3 ms)
    Ã¢Å“â€œ should fail when the webhook assertion fails
    Ã¢Å“â€œ should fail when the webhook returns an error (1 ms)
    Ã¢Å“â€œ should pass when the rouge-n assertion passes (1 ms)
    Ã¢Å“â€œ should fail when the rouge-n assertion fails
  assertionFromString
    Ã¢Å“â€œ should create an equality assertion (1 ms)
    Ã¢Å“â€œ should create an is-json assertion
    Ã¢Å“â€œ should create an contains-json assertion
    Ã¢Å“â€œ should create a function assertion
    Ã¢Å“â€œ should create a similarity assertion (1 ms)
    Ã¢Å“â€œ should create a contains assertion
    Ã¢Å“â€œ should create a not-contains assertion (1 ms)
    Ã¢Å“â€œ should create a contains-any assertion (1 ms)
    Ã¢Å“â€œ should create a contains-all assertion
    Ã¢Å“â€œ should create a regex assertion (1 ms)
    Ã¢Å“â€œ should create a not-regex assertion
    Ã¢Å“â€œ should create an icontains assertion
    Ã¢Å“â€œ should create a not-icontains assertion
    Ã¢Å“â€œ should create a webhook assertion (1 ms)
    Ã¢Å“â€œ should create a not-webhook assertion
    Ã¢Å“â€œ should create a rouge-n assertion (1 ms)
    Ã¢Å“â€œ should create a not-rouge-n assertion
  matchesSimilarity
    Ã¢Å“â€œ should pass when similarity is above the threshold (1 ms)
    Ã¢Å“â€œ should fail when similarity is below the threshold (1 ms)
    Ã¢Å“â€œ should fail when inverted similarity is above the threshold
    Ã¢Å“â€œ should pass when inverted similarity is below the threshold (1 ms)
  matchesLlmRubric
    Ã¢Å“â€œ should pass when the grading provider returns a passing result (5 ms)
    Ã¢Å“â€œ should fail when the grading provider returns a failing result (1 ms)

Test Suites: 2 failed, 5 passed, 7 total
Tests:       1 failed, 91 passed, 92 total
Snapshots:   0 total
Time:        6.349 s
